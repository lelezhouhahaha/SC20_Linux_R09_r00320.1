/*============================================================================

  Copyright (c) 2012,2015 Qualcomm Technologies, Inc.
  All Rights Reserved.
  Confidential and Proprietary - Qualcomm Technologies, Inc.

============================================================================*/
#include <media/msmb_isp.h>
#include "camera_dbg.h"
#include "gamma40.h"
#include "isp_log.h"

#ifdef ENABLE_GAMMA_LOGGING
  #undef ISP_DBG
  #define ISP_DBG LOGE
#endif

#if 0
#undef ISP_DBG
#define ISP_DBG ALOGE
#endif

#undef CDBG_ERROR
#define CDBG_ERROR ALOGE

#define DEFAULT_CONTRAST 5


static const uint8_t ipl_gammaSigmoid0_5[256] = {
  0,  11,  16,  20,  23,  25,  28,  30,  32,  34,
 36,  37,  39,  41,  42,  44,  45,  47,  48,  49,
 50,  52,  53,  54,  55,  56,  58,  59,  60,  61,
 62,  63,  64,  65,  66,  67,  68,  69,  70,  71,
 71,  72,  73,  74,  75,  76,  77,  77,  78,  79,
 80,  81,  81,  82,  83,  84,  84,  85,  86,  87,
 87,  88,  89,  90,  90,  91,  92,  92,  93,  94,
 94,  95,  96,  96,  97,  98,  98,  99, 100, 100,
101, 102, 102, 103, 103, 104, 105, 105, 106, 107,
107, 108, 108, 109, 109, 110, 111, 111, 112, 112,
113, 113, 114, 115, 115, 116, 116, 117, 117, 118,
118, 119, 119, 120, 121, 121, 122, 122, 123, 123,
124, 124, 125, 125, 126, 126, 127, 127, 128, 128,
129, 129, 130, 130, 131, 131, 132, 132, 133, 133,
134, 134, 135, 136, 136, 137, 137, 138, 138, 139,
139, 140, 140, 141, 142, 142, 143, 143, 144, 144,
145, 146, 146, 147, 147, 148, 148, 149, 150, 150,
151, 152, 152, 153, 153, 154, 155, 155, 156, 157,
157, 158, 159, 159, 160, 161, 161, 162, 163, 163,
164, 165, 165, 166, 167, 168, 168, 169, 170, 171,
171, 172, 173, 174, 174, 175, 176, 177, 178, 178,
179, 180, 181, 182, 183, 184, 184, 185, 186, 187,
188, 189, 190, 191, 192, 193, 194, 195, 196, 197,
199, 200, 201, 202, 203, 205, 206, 207, 208, 210,
211, 213, 214, 216, 218, 219, 221, 223, 225, 227,
230, 232, 235, 239, 244, 255
};

static const uint8_t ipl_gammaSigmoid0_6[256] = {
  0,   7,  11,  13,  16,  18,  20,  22,  24,  26,
 28,  29,  31,  32,  34,  35,  37,  38,  39,  41,
 42,  43,  44,  46,  47,  48,  49,  50,  51,  52,
 54,  55,  56,  57,  58,  59,  60,  61,  62,  63,
 64,  65,  65,  66,  67,  68,  69,  70,  71,  72,
 73,  74,  74,  75,  76,  77,  78,  79,  79,  80,
 81,  82,  83,  84,  84,  85,  86,  87,  87,  88,
 89,  90,  90,  91,  92,  93,  93,  94,  95,  96,
 96,  97,  98,  99,  99, 100, 101, 101, 102, 103,
103, 104, 105, 106, 106, 107, 108, 108, 109, 110,
110, 111, 112, 112, 113, 113, 114, 115, 115, 116,
117, 117, 118, 119, 119, 120, 120, 121, 122, 122,
123, 124, 124, 125, 125, 126, 127, 127, 128, 128,
129, 130, 130, 131, 131, 132, 133, 133, 134, 135,
135, 136, 136, 137, 138, 138, 139, 140, 140, 141,
142, 142, 143, 143, 144, 145, 145, 146, 147, 147,
148, 149, 149, 150, 151, 152, 152, 153, 154, 154,
155, 156, 156, 157, 158, 159, 159, 160, 161, 162,
162, 163, 164, 165, 165, 166, 167, 168, 168, 169,
170, 171, 171, 172, 173, 174, 175, 176, 176, 177,
178, 179, 180, 181, 181, 182, 183, 184, 185, 186,
187, 188, 189, 190, 190, 191, 192, 193, 194, 195,
196, 197, 198, 199, 200, 201, 203, 204, 205, 206,
207, 208, 209, 211, 212, 213, 214, 216, 217, 218,
220, 221, 223, 224, 226, 227, 229, 231, 233, 235,
237, 239, 242, 244, 248, 255
};

static const uint8_t ipl_gammaSigmoid0_7[256] = {
  0,   4,   7,   9,  11,  13,  15,  17,  18,  20,
 21,  23,  24,  26,  27,  29,  30,  31,  32,  34,
 35,  36,  37,  38,  40,  41,  42,  43,  44,  45,
 46,  47,  48,  50,  51,  52,  53,  54,  55,  56,
 57,  58,  59,  60,  61,  62,  62,  63,  64,  65,
 66,  67,  68,  69,  70,  71,  72,  73,  73,  74,
 75,  76,  77,  78,  79,  80,  80,  81,  82,  83,
 84,  85,  85,  86,  87,  88,  89,  90,  90,  91,
 92,  93,  94,  94,  95,  96,  97,  98,  98,  99,
100, 101, 101, 102, 103, 104, 105, 105, 106, 107,
108, 108, 109, 110, 111, 111, 112, 113, 114, 114,
115, 116, 116, 117, 118, 119, 119, 120, 121, 121,
122, 123, 124, 124, 125, 126, 126, 127, 128, 129,
129, 130, 131, 131, 132, 133, 134, 134, 135, 136,
136, 137, 138, 139, 139, 140, 141, 141, 142, 143,
144, 144, 145, 146, 147, 147, 148, 149, 150, 150,
151, 152, 153, 154, 154, 155, 156, 157, 157, 158,
159, 160, 161, 161, 162, 163, 164, 165, 165, 166,
167, 168, 169, 170, 170, 171, 172, 173, 174, 175,
175, 176, 177, 178, 179, 180, 181, 182, 182, 183,
184, 185, 186, 187, 188, 189, 190, 191, 192, 193,
193, 194, 195, 196, 197, 198, 199, 200, 201, 202,
203, 204, 205, 207, 208, 209, 210, 211, 212, 213,
214, 215, 217, 218, 219, 220, 221, 223, 224, 225,
226, 228, 229, 231, 232, 234, 235, 237, 238, 240,
242, 244, 246, 248, 251, 255
};

static const uint8_t ipl_gammaSigmoid0_8[256] = {
  0,   3,   5,   6,   8,  10,  11,  13,  14,  15,
 17,  18,  19,  21,  22,  23,  24,  25,  27,  28,
 29,  30,  31,  32,  34,  35,  36,  37,  38,  39,
 40,  41,  42,  43,  44,  45,  46,  47,  48,  49,
 50,  51,  52,  53,  54,  55,  56,  57,  58,  59,
 60,  61,  62,  63,  64,  65,  66,  67,  68,  69,
 70,  71,  72,  73,  73,  74,  75,  76,  77,  78,
 79,  80,  81,  82,  83,  83,  84,  85,  86,  87,
 88,  89,  90,  90,  91,  92,  93,  94,  95,  96,
 96,  97,  98,  99, 100, 101, 102, 102, 103, 104,
105, 106, 107, 107, 108, 109, 110, 111, 112, 112,
113, 114, 115, 116, 117, 117, 118, 119, 120, 121,
121, 122, 123, 124, 125, 125, 126, 127, 128, 129,
130, 130, 131, 132, 133, 134, 134, 135, 136, 137,
138, 138, 139, 140, 141, 142, 143, 143, 144, 145,
146, 147, 148, 148, 149, 150, 151, 152, 153, 153,
154, 155, 156, 157, 158, 159, 159, 160, 161, 162,
163, 164, 165, 165, 166, 167, 168, 169, 170, 171,
172, 172, 173, 174, 175, 176, 177, 178, 179, 180,
181, 182, 182, 183, 184, 185, 186, 187, 188, 189,
190, 191, 192, 193, 194, 195, 196, 197, 198, 199,
200, 201, 202, 203, 204, 205, 206, 207, 208, 209,
210, 211, 212, 213, 214, 215, 216, 217, 218, 219,
220, 221, 223, 224, 225, 226, 227, 228, 230, 231,
232, 233, 234, 236, 237, 238, 240, 241, 242, 244,
245, 247, 249, 250, 252, 255
};

static const uint8_t ipl_gammaSigmoid0_9[256] = {
  0,   2,   3,   4,   6,   7,   8,   9,  11,  12,
 13,  14,  15,  16,  17,  19,  20,  21,  22,  23,
 24,  25,  26,  27,  28,  29,  30,  32,  33,  34,
 35,  36,  37,  38,  39,  40,  41,  42,  43,  44,
 45,  46,  47,  48,  49,  50,  51,  52,  53,  54,
 55,  56,  57,  58,  59,  60,  61,  62,  63,  64,
 65,  66,  67,  68,  69,  70,  70,  71,  72,  73,
 74,  75,  76,  77,  78,  79,  80,  81,  82,  83,
 84,  85,  86,  87,  88,  89,  89,  90,  91,  92,
 93,  94,  95,  96,  97,  98,  99, 100, 101, 102,
102, 103, 104, 105, 106, 107, 108, 109, 110, 111,
112, 113, 113, 114, 115, 116, 117, 118, 119, 120,
121, 122, 123, 123, 124, 125, 126, 127, 128, 129,
130, 131, 132, 132, 133, 134, 135, 136, 137, 138,
139, 140, 141, 142, 142, 143, 144, 145, 146, 147,
148, 149, 150, 151, 152, 153, 153, 154, 155, 156,
157, 158, 159, 160, 161, 162, 163, 164, 165, 166,
166, 167, 168, 169, 170, 171, 172, 173, 174, 175,
176, 177, 178, 179, 180, 181, 182, 183, 184, 185,
185, 186, 187, 188, 189, 190, 191, 192, 193, 194,
195, 196, 197, 198, 199, 200, 201, 202, 203, 204,
205, 206, 207, 208, 209, 210, 211, 212, 213, 214,
215, 216, 217, 218, 219, 220, 221, 222, 223, 225,
226, 227, 228, 229, 230, 231, 232, 233, 234, 235,
236, 238, 239, 240, 241, 242, 243, 244, 246, 247,
248, 249, 251, 252, 253, 255
};


static const uint8_t ipl_gammaSigmoid1_0[256] = {
  0,   1,   2,   3,   4,   5,   6,   7,   8,   9,
 10,  11,  12,  13,  14,  15,  16,  17,  18,  19,
 20,  21,  22,  23,  24,  25,  26,  27,  28,  29,
 30,  31,  32,  33,  34,  35,  36,  37,  38,  39,
 40,  41,  42,  43,  44,  45,  46,  47,  48,  49,
 50,  51,  52,  53,  54,  55,  56,  57,  58,  59,
 60,  61,  62,  63,  64,  65,  66,  67,  68,  69,
 70,  71,  72,  73,  74,  75,  76,  77,  78,  79,
 80,  81,  82,  83,  84,  85,  86,  87,  88,  89,
 90,  91,  92,  93,  94,  95,  96,  97,  98,  99,
100, 101, 102, 103, 104, 105, 106, 107, 108, 109,
110, 111, 112, 113, 114, 115, 116, 117, 118, 119,
120, 121, 122, 123, 124, 125, 126, 127, 128, 129,
130, 131, 132, 133, 134, 135, 136, 137, 138, 139,
140, 141, 142, 143, 144, 145, 146, 147, 148, 149,
150, 151, 152, 153, 154, 155, 156, 157, 158, 159,
160, 161, 162, 163, 164, 165, 166, 167, 168, 169,
170, 171, 172, 173, 174, 175, 176, 177, 178, 179,
180, 181, 182, 183, 184, 185, 186, 187, 188, 189,
190, 191, 192, 193, 194, 195, 196, 197, 198, 199,
200, 201, 202, 203, 204, 205, 206, 207, 208, 209,
210, 211, 212, 213, 214, 215, 216, 217, 218, 219,
220, 221, 222, 223, 224, 225, 226, 227, 228, 229,
230, 231, 232, 233, 234, 235, 236, 237, 238, 239,
240, 241, 242, 243, 244, 245, 246, 247, 248, 249,
250, 251, 252, 253, 254, 255
};


static const uint8_t ipl_gammaSigmoid1_2[256] = {
  0,   0,   1,   1,   2,   3,   3,   4,   5,   5,
  6,   7,   7,   8,   9,  10,  11,  11,  12,  13,
 14,  15,  15,  16,  17,  18,  19,  20,  21,  22,
 22,  23,  24,  25,  26,  27,  28,  29,  30,  31,
 32,  33,  34,  35,  36,  37,  38,  38,  39,  40,
 41,  42,  43,  44,  45,  46,  48,  49,  50,  51,
 52,  53,  54,  55,  56,  57,  58,  59,  60,  61,
 62,  63,  64,  65,  66,  67,  69,  70,  71,  72,
 73,  74,  75,  76,  77,  78,  79,  81,  82,  83,
 84,  85,  86,  87,  88,  90,  91,  92,  93,  94,
 95,  96,  98,  99, 100, 101, 102, 103, 104, 106,
107, 108, 109, 110, 111, 113, 114, 115, 116, 117,
119, 120, 121, 122, 123, 125, 126, 127, 128, 129,
130, 132, 133, 134, 135, 136, 138, 139, 140, 141,
142, 144, 145, 146, 147, 148, 149, 151, 152, 153,
154, 155, 156, 157, 159, 160, 161, 162, 163, 164,
165, 167, 168, 169, 170, 171, 172, 173, 174, 176,
177, 178, 179, 180, 181, 182, 183, 184, 185, 186,
188, 189, 190, 191, 192, 193, 194, 195, 196, 197,
198, 199, 200, 201, 202, 203, 204, 205, 206, 207,
209, 210, 211, 212, 213, 214, 215, 216, 217, 217,
218, 219, 220, 221, 222, 223, 224, 225, 226, 227,
228, 229, 230, 231, 232, 233, 233, 234, 235, 236,
237, 238, 239, 240, 240, 241, 242, 243, 244, 244,
245, 246, 247, 248, 248, 249, 250, 250, 251, 252,
252, 253, 254, 254, 255, 255
};


static const uint8_t ipl_gammaSigmoid1_5[256] = {
  0,   0,   0,   0,   1,   1,   1,   2,   2,   2,
  3,   3,   4,   4,   5,   5,   6,   6,   7,   7,
  8,   9,   9,  10,  10,  11,  12,  12,  13,  14,
 15,  15,  16,  17,  18,  18,  19,  20,  21,  22,
 22,  23,  24,  25,  26,  27,  28,  29,  29,  30,
 31,  32,  33,  34,  35,  36,  37,  38,  39,  40,
 41,  42,  43,  44,  45,  46,  47,  49,  50,  51,
 52,  53,  54,  55,  56,  58,  59,  60,  61,  62,
 63,  65,  66,  67,  68,  69,  71,  72,  73,  74,
 76,  77,  78,  79,  81,  82,  83,  85,  86,  87,
 89,  90,  91,  93,  94,  95,  97,  98,  99, 101,
102, 104, 105, 106, 108, 109, 111, 112, 114, 115,
116, 118, 119, 121, 122, 124, 125, 127, 128, 130,
131, 133, 134, 136, 137, 139, 140, 141, 143, 144,
146, 147, 149, 150, 151, 153, 154, 156, 157, 158,
160, 161, 162, 164, 165, 166, 168, 169, 170, 172,
173, 174, 176, 177, 178, 179, 181, 182, 183, 184,
186, 187, 188, 189, 190, 192, 193, 194, 195, 196,
197, 199, 200, 201, 202, 203, 204, 205, 206, 208,
209, 210, 211, 212, 213, 214, 215, 216, 217, 218,
219, 220, 221, 222, 223, 224, 225, 226, 226, 227,
228, 229, 230, 231, 232, 233, 233, 234, 235, 236,
237, 237, 238, 239, 240, 240, 241, 242, 243, 243,
244, 245, 245, 246, 246, 247, 248, 248, 249, 249,
250, 250, 251, 251, 252, 252, 253, 253, 253, 254,
254, 254, 255, 255, 255, 255
};


static const uint8_t ipl_gammaSigmoid1_8[256] = {
  0,   0,   0,   0,   0,   0,   1,   1,   1,   1,
  1,   2,   2,   2,   2,   3,   3,   3,   4,   4,
  5,   5,   5,   6,   6,   7,   7,   8,   8,   9,
  9,  10,  11,  11,  12,  12,  13,  14,  14,  15,
 16,  17,  17,  18,  19,  20,  20,  21,  22,  23,
 24,  25,  25,  26,  27,  28,  29,  30,  31,  32,
 33,  34,  35,  36,  37,  38,  39,  40,  41,  42,
 43,  44,  46,  47,  48,  49,  50,  51,  53,  54,
 55,  56,  58,  59,  60,  61,  63,  64,  65,  67,
 68,  69,  71,  72,  74,  75,  77,  78,  79,  81,
 82,  84,  85,  87,  88,  90,  91,  93,  95,  96,
 98,  99, 101, 103, 104, 106, 108, 109, 111, 113,
114, 116, 118, 120, 121, 123, 125, 127, 128, 130,
132, 134, 135, 137, 139, 141, 142, 144, 146, 147,
149, 151, 152, 154, 156, 157, 159, 160, 162, 164,
165, 167, 168, 170, 171, 173, 174, 176, 177, 178,
180, 181, 183, 184, 186, 187, 188, 190, 191, 192,
194, 195, 196, 197, 199, 200, 201, 202, 204, 205,
206, 207, 208, 209, 211, 212, 213, 214, 215, 216,
217, 218, 219, 220, 221, 222, 223, 224, 225, 226,
227, 228, 229, 230, 230, 231, 232, 233, 234, 235,
235, 236, 237, 238, 238, 239, 240, 241, 241, 242,
243, 243, 244, 244, 245, 246, 246, 247, 247, 248,
248, 249, 249, 250, 250, 250, 251, 251, 252, 252,
252, 253, 253, 253, 253, 254, 254, 254, 254, 254,
255, 255, 255, 255, 255, 255
};


static const uint8_t ipl_gammaSigmoid2_1[256] = {
  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
  1,   1,   1,   1,   1,   1,   2,   2,   2,   2,
  3,   3,   3,   3,   4,   4,   5,   5,   5,   6,
  6,   7,   7,   7,   8,   8,   9,   9,  10,  11,
 11,  12,  12,  13,  14,  14,  15,  16,  16,  17,
 18,  19,  19,  20,  21,  22,  23,  24,  24,  25,
 26,  27,  28,  29,  30,  31,  32,  33,  34,  35,
 36,  37,  38,  40,  41,  42,  43,  44,  45,  47,
 48,  49,  50,  52,  53,  54,  56,  57,  59,  60,
 61,  63,  64,  66,  67,  69,  70,  72,  73,  75,
 77,  78,  80,  81,  83,  85,  87,  88,  90,  92,
 94,  95,  97,  99, 101, 103, 105, 106, 108, 110,
112, 114, 116, 118, 120, 122, 124, 126, 129, 131,
133, 135, 137, 139, 141, 143, 145, 147, 149, 150,
152, 154, 156, 158, 160, 161, 163, 165, 167, 168,
170, 172, 174, 175, 177, 178, 180, 182, 183, 185,
186, 188, 189, 191, 192, 194, 195, 196, 198, 199,
201, 202, 203, 205, 206, 207, 208, 210, 211, 212,
213, 214, 215, 217, 218, 219, 220, 221, 222, 223,
224, 225, 226, 227, 228, 229, 230, 231, 231, 232,
233, 234, 235, 236, 236, 237, 238, 239, 239, 240,
241, 241, 242, 243, 243, 244, 244, 245, 246, 246,
247, 247, 248, 248, 248, 249, 249, 250, 250, 250,
251, 251, 252, 252, 252, 252, 253, 253, 253, 253,
254, 254, 254, 254, 254, 254, 255, 255, 255, 255,
255, 255, 255, 255, 255, 255
};


static const uint8_t ipl_gammaSigmoid2_4[256] = {
  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
  0,   0,   0,   1,   1,   1,   1,   1,   1,   1,
  1,   2,   2,   2,   2,   3,   3,   3,   3,   4,
  4,   4,   5,   5,   5,   6,   6,   7,   7,   7,
  8,   8,   9,   9,  10,  10,  11,  12,  12,  13,
 13,  14,  15,  16,  16,  17,  18,  18,  19,  20,
 21,  22,  23,  23,  24,  25,  26,  27,  28,  29,
 30,  31,  32,  33,  35,  36,  37,  38,  39,  40,
 42,  43,  44,  46,  47,  48,  50,  51,  52,  54,
 55,  57,  58,  60,  61,  63,  65,  66,  68,  69,
 71,  73,  75,  76,  78,  80,  82,  84,  86,  88,
 89,  91,  93,  95,  97, 100, 102, 104, 106, 108,
110, 112, 115, 117, 119, 122, 124, 126, 129, 131,
133, 136, 138, 140, 143, 145, 147, 149, 151, 153,
155, 158, 160, 162, 164, 166, 167, 169, 171, 173,
175, 177, 179, 180, 182, 184, 186, 187, 189, 190,
192, 194, 195, 197, 198, 200, 201, 203, 204, 205,
207, 208, 209, 211, 212, 213, 215, 216, 217, 218,
219, 220, 222, 223, 224, 225, 226, 227, 228, 229,
230, 231, 232, 232, 233, 234, 235, 236, 237, 237,
238, 239, 239, 240, 241, 242, 242, 243, 243, 244,
245, 245, 246, 246, 247, 247, 248, 248, 248, 249,
249, 250, 250, 250, 251, 251, 251, 252, 252, 252,
252, 253, 253, 253, 253, 254, 254, 254, 254, 254,
254, 254, 254, 255, 255, 255, 255, 255, 255, 255,
255, 255, 255, 255, 255, 255
};

static const uint8_t VFE_Whiteboard_GammaTable[1024] = {
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 4, 4, 5, 5,
  6, 6, 7, 7, 8, 8, 9, 9, 10, 11, 11, 12, 12, 13, 13, 14,
  14, 15, 16, 16, 17, 18, 19, 20, 20, 21, 22, 22, 23, 24, 24, 25,
  26, 27, 28, 28, 29, 30, 31, 32, 33, 34, 35, 35, 36, 37, 38, 39,
  40, 41, 42, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 53, 54, 55,
  56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 68, 69, 70, 71, 72,
  73, 74, 76, 77, 78, 79, 80, 81, 83, 84, 85, 86, 88, 89, 90, 91,
  92, 94, 95, 96, 97, 98, 100, 101, 102, 103, 104, 106, 107, 108, 109, 110,
  112, 113, 114, 115, 116, 117, 118, 119, 121, 122, 123, 124, 125, 126, 127,
  128,
  130, 131, 132, 133, 134, 135, 136, 137, 139, 140, 141, 142, 143, 144, 145,
  146,
  147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161,
  162,
  163, 164, 165, 166, 166, 167, 168, 169, 170, 171, 172, 173, 174, 174, 175,
  176,
  177, 178, 179, 179, 180, 181, 182, 183, 183, 184, 185, 185, 186, 187, 187,
  188,
  189, 190, 190, 191, 192, 192, 193, 194, 194, 195, 196, 196, 197, 198, 198,
  199,
  200, 201, 201, 202, 202, 203, 203, 204, 205, 205, 206, 207, 207, 207, 208,
  209,
  209, 209, 210, 210, 210, 211, 212, 212, 212, 213, 214, 214, 215, 215, 216,
  216,
  216, 217, 217, 218, 218, 219, 219, 220, 220, 221, 221, 221, 222, 222, 222,
  223,
  223, 224, 224, 224, 225, 225, 225, 226, 226, 227, 227, 227, 228, 228, 228,
  229,
  229, 230, 230, 230, 231, 231, 231, 231, 232, 232, 232, 233, 233, 234, 234,
  234,
  235, 235, 235, 235, 235, 236, 236, 236, 236, 237, 237, 237, 237, 238, 238,
  238,
  239, 239, 239, 240, 240, 240, 241, 241, 241, 241, 242, 242, 242, 242, 242,
  243,
  243, 243, 243, 244, 244, 244, 244, 244, 245, 245, 245, 245, 245, 246, 246,
  246,
  246, 246, 246, 246, 246, 246, 247, 247, 247, 247, 247, 248, 248, 248, 248,
  248,
  249, 249, 249, 249, 249, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250,
  251,
  251, 251, 251, 251, 252, 252, 252, 252, 252, 252, 252, 252, 252, 252, 253,
  253,
  253, 253, 253, 253, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
};

static const uint8_t VFE_Posterization_GammaTable[1024] = {
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 85, 85, 85, 85, 85, 85,
  85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85,
  85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85,
  85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85,
  85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85,
  85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85,
  85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85,
  85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85,
  85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85,
  85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85,
  85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85,
  85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 170, 170, 170, 170, 170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  170,
  170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
  255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,
  255,
};

static const uint8_t VFE_Blackboard_GammaTable[1024] = {
  /* Gamma table */
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3,
  4, 4, 4, 4, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7, 8, 8,
  8, 9, 9, 9, 9, 10, 10, 10, 11, 11, 11, 12, 12, 12, 13, 13,
  13, 14, 14, 14, 15, 15, 16, 16, 16, 17, 17, 17, 18, 18, 18, 19,
  19, 20, 20, 20, 21, 21, 22, 22, 22, 23, 23, 23, 24, 24, 24, 24,
  25, 25, 26, 26, 26, 27, 27, 28, 28, 28, 29, 29, 30, 30, 30, 31,
  31, 32, 32, 32, 33, 33, 33, 34, 34, 35, 35, 36, 36, 37, 37, 38,
  38, 39, 39, 39, 40, 40, 40, 41, 41, 42, 42, 42, 43, 43, 43, 44,
  44, 45, 45, 46, 46, 47, 47, 47, 48, 48, 48, 49, 49, 49, 50, 50,
  51, 51, 52, 52, 53, 53, 53, 54, 54, 54, 55, 55, 56, 56, 57, 57,
  58, 58, 58, 59, 59, 60, 60, 61, 61, 61, 62, 62, 63, 63, 63, 64,
  64, 65, 65, 66, 66, 66, 67, 67, 67, 68, 68, 69, 69, 69, 70, 70,
  71, 71, 71, 72, 72, 73, 73, 74, 74, 74, 75, 75, 76, 76, 77, 77,
  77, 78, 78, 79, 79, 79, 80, 80, 80, 81, 81, 81, 82, 82, 83, 83,
  83, 84, 84, 85, 85, 86, 86, 86, 87, 87, 87, 88, 88, 89, 89, 89,
  90, 90, 90, 91, 91, 92, 92, 92, 93, 93, 93, 94, 94, 95, 95, 95,
  96, 96, 96, 97, 97, 98, 98, 99, 99, 100, 100, 100, 101, 101, 101, 102,
  102, 102, 103, 103, 103, 104, 104, 104, 105, 105, 106, 106, 106, 107, 107,
  107,
  108, 108, 108, 109, 109, 110, 110, 111, 111, 111, 112, 112, 112, 113, 113,
  113,
  114, 114, 115, 115, 115, 116, 116, 116, 117, 117, 117, 118, 118, 118, 119,
  119,
  119, 120, 120, 120, 121, 121, 121, 122, 122, 122, 123, 123, 123, 124, 124,
  124,
  125, 125, 125, 126, 126, 126, 127, 127, 127, 128, 128, 128, 129, 129, 129,
  130,
  130, 130, 131, 131, 131, 132, 132, 132, 133, 133, 134, 134, 134, 135, 135,
  135,
  136, 136, 136, 136, 137, 137, 137, 138, 138, 138, 139, 139, 139, 140, 140,
  140,
  141, 141, 141, 141, 142, 142, 142, 143, 143, 143, 143, 144, 144, 145, 145,
  145,
  145, 146, 146, 147, 147, 147, 147, 148, 148, 148, 149, 149, 149, 149, 150,
  150,
  150, 150, 151, 151, 152, 152, 152, 152, 153, 153, 154, 154, 154, 154, 155,
  155,
  155, 155, 156, 156, 156, 156, 157, 157, 157, 157, 158, 158, 159, 159, 159,
  159,
  160, 160, 160, 161, 161, 161, 161, 162, 162, 163, 163, 163, 163, 164, 164,
  164,
  164, 165, 165, 165, 165, 165, 166, 166, 166, 166, 167, 167, 167, 168, 168,
  168,
  168, 169, 169, 170, 170, 170, 170, 171, 171, 171, 172, 172, 172, 172, 173,
  173,
  173, 173, 173, 174, 174, 174, 174, 174, 175, 175, 175, 175, 176, 176, 176,
  177,
  177, 177, 177, 178, 178, 178, 179, 179, 179, 179, 180, 180, 180, 181, 181,
  181,
  181, 182, 182, 182, 182, 183, 183, 183, 183, 184, 184, 184, 184, 184, 185,
  185,
  185, 185, 185, 185, 186, 186, 186, 186, 187, 187, 187, 188, 188, 188, 188,
  189,
  189, 189, 189, 190, 190, 190, 190, 191, 191, 191, 191, 192, 192, 192, 192,
  193,
  193, 193, 193, 194, 194, 194, 194, 195, 195, 195, 195, 196, 196, 196, 196,
  197,
  197, 197, 197, 197, 197, 198, 198, 198, 198, 198, 198, 198, 199, 199, 199,
  199,
  200, 200, 200, 200, 201, 201, 201, 201, 202, 202, 202, 202, 202, 203, 203,
  203,
  203, 204, 204, 204, 204, 205, 205, 205, 205, 206, 206, 206, 206, 206, 207,
  207,
  207, 207, 208, 208, 208, 208, 208, 209, 209, 209, 209, 210, 210, 210, 210,
  210,
  210, 210, 211, 211, 211, 211, 211, 211, 211, 211, 212, 212, 212, 212, 213,
  213,
  213, 213, 213, 214, 214, 214, 214, 215, 215, 215, 215, 215, 215, 216, 216,
  216,
  216, 217, 217, 217, 217, 217, 218, 218, 218, 218, 219, 219, 219, 219, 219,
  219,
  220, 220, 220, 220, 221, 221, 221, 221, 221, 221, 222, 222, 222, 222, 223,
  223,
  223, 223, 223, 223, 224, 224, 224, 224, 225, 225, 225, 225, 225, 225, 225,
  226,
  226, 226, 226, 227, 227, 227, 227, 227, 227, 227, 227, 228, 228, 228, 228,
  228,
  228, 228, 228, 228, 229, 229, 229, 229, 230, 230, 230, 230, 230, 230, 230,
  231,
  231, 231, 231, 232, 232, 232, 232, 232, 232, 232, 233, 233, 233, 233, 234,
  234,
  234, 234, 234, 234, 234, 235, 235, 235, 235, 236, 236, 236, 236, 236, 236,
  236,
  236, 237, 237, 237, 237, 238, 238, 238, 238, 238, 238, 238, 239, 239, 239,
  239,
  240, 240, 240, 240, 240, 240, 240, 240, 241, 241, 241, 241, 242, 242, 242,
  242,
  242, 242, 242, 242, 243, 243, 243, 243, 244, 244, 244, 244, 244, 244, 244,
  244,
  244, 244, 244, 245, 245, 245, 245, 245, 245, 245, 245, 245, 245, 246, 246,
  246,
  246, 247, 247, 247, 247, 247, 247, 247, 247, 247, 248, 248, 248, 248, 249,
  249,
  249, 249, 249, 249, 249, 249, 249, 250, 250, 250, 250, 251, 251, 251, 251,
  251,
  251, 251, 251, 251, 252, 252, 252, 252, 253, 253, 253, 253, 253, 253, 254,
  255,
};

// ADRC gain LUT
static adrc_gain_lut_t adrc_gain_lut_table[ADRC_GAIN_TABLE_LENGTH] =
{
  { // 1: x1.000
    1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000,
    1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000,
    1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000,
    1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000,
  },

  { // 2: x1.030
    1.0300, 1.0300, 1.0300, 1.0300, 1.0300, 1.0300, 1.0300, 1.0300, 1.0300, 1.0300, 1.0300, 1.0300, 1.0300, 1.0292, 1.0278, 1.0267,
    1.0257, 1.0248, 1.0241, 1.0234, 1.0227, 1.0222, 1.0216, 1.0212, 1.0207, 1.0203, 1.0197, 1.0190, 1.0184, 1.0178, 1.0172, 1.0167,
    1.0162, 1.0157, 1.0153, 1.0148, 1.0145, 1.0141, 1.0137, 1.0131, 1.0125, 1.0119, 1.0113, 1.0108, 1.0102, 1.0097, 1.0093, 1.0088,
    1.0084, 1.0080, 1.0075, 1.0072, 1.0065, 1.0059, 1.0052, 1.0046, 1.0040, 1.0035, 1.0029, 1.0024, 1.0019, 1.0014, 1.0009, 1.0004,
  },

  { // 3: x1.061
    1.0609, 1.0609, 1.0609, 1.0609, 1.0609, 1.0609, 1.0609, 1.0609, 1.0609, 1.0609, 1.0609, 1.0609, 1.0609, 1.0581, 1.0555, 1.0533,
    1.0513, 1.0496, 1.0481, 1.0467, 1.0455, 1.0444, 1.0433, 1.0424, 1.0416, 1.0408, 1.0393, 1.0379, 1.0367, 1.0355, 1.0344, 1.0333,
    1.0324, 1.0314, 1.0306, 1.0298, 1.0290, 1.0283, 1.0276, 1.0263, 1.0250, 1.0238, 1.0227, 1.0216, 1.0205, 1.0196, 1.0186, 1.0177,
    1.0168, 1.0160, 1.0152, 1.0144, 1.0131, 1.0117, 1.0105, 1.0093, 1.0081, 1.0069, 1.0058, 1.0048, 1.0038, 1.0028, 1.0018, 1.0009,
  },

  { // 4: x1.093
    1.0927, 1.0927, 1.0927, 1.0927, 1.0927, 1.0927, 1.0927, 1.0927, 1.0927, 1.0927, 1.0927, 1.0927, 1.0913, 1.0869, 1.0831, 1.0798,
    1.0769, 1.0743, 1.0721, 1.0700, 1.0682, 1.0666, 1.0651, 1.0637, 1.0624, 1.0610, 1.0588, 1.0568, 1.0549, 1.0532, 1.0515, 1.0500,
    1.0486, 1.0472, 1.0460, 1.0448, 1.0436, 1.0426, 1.0414, 1.0394, 1.0375, 1.0358, 1.0341, 1.0325, 1.0309, 1.0294, 1.0280, 1.0267,
    1.0254, 1.0241, 1.0229, 1.0217, 1.0196, 1.0177, 1.0158, 1.0139, 1.0122, 1.0104, 1.0088, 1.0072, 1.0057, 1.0042, 1.0027, 1.0013,
  },

  { // 5: x1.126
    1.1255, 1.1255, 1.1255, 1.1255, 1.1255, 1.1255, 1.1255, 1.1255, 1.1255, 1.1255, 1.1255, 1.1255, 1.1213, 1.1155, 1.1105, 1.1062,
    1.1024, 1.0990, 1.0961, 1.0934, 1.0910, 1.0888, 1.0869, 1.0851, 1.0834, 1.0812, 1.0783, 1.0756, 1.0732, 1.0709, 1.0687, 1.0667,
    1.0649, 1.0631, 1.0614, 1.0599, 1.0584, 1.0570, 1.0552, 1.0526, 1.0501, 1.0478, 1.0455, 1.0434, 1.0413, 1.0394, 1.0375, 1.0357,
    1.0340, 1.0324, 1.0308, 1.0290, 1.0263, 1.0236, 1.0211, 1.0186, 1.0163, 1.0140, 1.0118, 1.0096, 1.0076, 1.0056, 1.0037, 1.0018,
  },

  { // 6: x1.159
    1.1593, 1.1593, 1.1593, 1.1593, 1.1593, 1.1593, 1.1593, 1.1593, 1.1593, 1.1593, 1.1593, 1.1593, 1.1511, 1.1440, 1.1378, 1.1325,
    1.1278, 1.1237, 1.1200, 1.1168, 1.1138, 1.1112, 1.1087, 1.1065, 1.1045, 1.1012, 1.0977, 1.0945, 1.0914, 1.0886, 1.0860, 1.0835,
    1.0812, 1.0791, 1.0770, 1.0751, 1.0733, 1.0716, 1.0691, 1.0658, 1.0628, 1.0598, 1.0571, 1.0544, 1.0519, 1.0494, 1.0471, 1.0449,
    1.0428, 1.0407, 1.0388, 1.0365, 1.0330, 1.0297, 1.0265, 1.0234, 1.0204, 1.0175, 1.0148, 1.0121, 1.0095, 1.0070, 1.0046, 1.0022,
  },

  { // 7: x1.194
    1.1941, 1.1941, 1.1941, 1.1941, 1.1941, 1.1941, 1.1941, 1.1941, 1.1941, 1.1941, 1.1941, 1.1909, 1.1808, 1.1724, 1.1651, 1.1588,
    1.1533, 1.1484, 1.1441, 1.1402, 1.1367, 1.1336, 1.1307, 1.1281, 1.1257, 1.1213, 1.1171, 1.1133, 1.1097, 1.1064, 1.1033, 1.1004,
    1.0977, 1.0951, 1.0927, 1.0905, 1.0883, 1.0863, 1.0830, 1.0791, 1.0755, 1.0720, 1.0687, 1.0655, 1.0625, 1.0596, 1.0568, 1.0542,
    1.0516, 1.0492, 1.0469, 1.0439, 1.0398, 1.0358, 1.0319, 1.0282, 1.0246, 1.0211, 1.0178, 1.0146, 1.0115, 1.0084, 1.0055, 1.0027,
  },

  { // 8: x1.230
    1.2299, 1.2299, 1.2299, 1.2299, 1.2299, 1.2299, 1.2299, 1.2299, 1.2299, 1.2299, 1.2299, 1.2220, 1.2104, 1.2007, 1.1923, 1.1851,
    1.1787, 1.1731, 1.1681, 1.1637, 1.1597, 1.1561, 1.1528, 1.1497, 1.1464, 1.1413, 1.1365, 1.1321, 1.1281, 1.1243, 1.1207, 1.1174,
    1.1143, 1.1113, 1.1086, 1.1060, 1.1035, 1.1012, 1.0970, 1.0925, 1.0883, 1.0842, 1.0804, 1.0767, 1.0732, 1.0699, 1.0666, 1.0636,
    1.0606, 1.0578, 1.0551, 1.0515, 1.0466, 1.0419, 1.0374, 1.0330, 1.0288, 1.0248, 1.0209, 1.0171, 1.0134, 1.0099, 1.0065, 1.0032,
  },

  { // 9: x1.267
    1.2668, 1.2668, 1.2668, 1.2668, 1.2668, 1.2668, 1.2668, 1.2668, 1.2668, 1.2668, 1.2668, 1.2529, 1.2399, 1.2289, 1.2195, 1.2113,
    1.2042, 1.1979, 1.1923, 1.1872, 1.1827, 1.1786, 1.1749, 1.1715, 1.1671, 1.1613, 1.1560, 1.1510, 1.1465, 1.1422, 1.1382, 1.1345,
    1.1310, 1.1277, 1.1246, 1.1217, 1.1189, 1.1163, 1.1111, 1.1060, 1.1012, 1.0966, 1.0922, 1.0880, 1.0841, 1.0802, 1.0766, 1.0731,
    1.0698, 1.0666, 1.0635, 1.0592, 1.0536, 1.0482, 1.0430, 1.0380, 1.0331, 1.0285, 1.0240, 1.0196, 1.0154, 1.0114, 1.0074, 1.0036,
  },

  { // 10: x1.305
    1.3048, 1.3048, 1.3048, 1.3048, 1.3048, 1.3048, 1.3048, 1.3048, 1.3048, 1.3048, 1.3010, 1.2837, 1.2693, 1.2571, 1.2467, 1.2376,
    1.2297, 1.2227, 1.2164, 1.2109, 1.2059, 1.2013, 1.1972, 1.1934, 1.1878, 1.1814, 1.1755, 1.1700, 1.1649, 1.1602, 1.1558, 1.1517,
    1.1478, 1.1442, 1.1408, 1.1376, 1.1345, 1.1313, 1.1253, 1.1196, 1.1142, 1.1091, 1.1042, 1.0995, 1.0950, 1.0908, 1.0867, 1.0828,
    1.0791, 1.0755, 1.0721, 1.0669, 1.0606, 1.0545, 1.0486, 1.0429, 1.0375, 1.0322, 1.0271, 1.0222, 1.0175, 1.0129, 1.0084, 1.0041,
  },

  { // 11: x1.344
    1.3439, 1.3439, 1.3439, 1.3439, 1.3439, 1.3439, 1.3439, 1.3439, 1.3439, 1.3439, 1.3334, 1.3145, 1.2987, 1.2853, 1.2738, 1.2639,
    1.2552, 1.2475, 1.2407, 1.2346, 1.2291, 1.2241, 1.2196, 1.2155, 1.2085, 1.2015, 1.1950, 1.1891, 1.1835, 1.1784, 1.1736, 1.1691,
    1.1648, 1.1609, 1.1571, 1.1536, 1.1503, 1.1462, 1.1396, 1.1333, 1.1273, 1.1217, 1.1162, 1.1111, 1.1062, 1.1015, 1.0970, 1.0927,
    1.0885, 1.0846, 1.0808, 1.0748, 1.0677, 1.0609, 1.0543, 1.0480, 1.0419, 1.0360, 1.0303, 1.0248, 1.0195, 1.0144, 1.0094, 1.0046,
  },

  { // 12: x1.384
    1.3842, 1.3842, 1.3842, 1.3842, 1.3842, 1.3842, 1.3842, 1.3842, 1.3842, 1.3842, 1.3657, 1.3451, 1.3280, 1.3135, 1.3010, 1.2902,
    1.2808, 1.2725, 1.2651, 1.2584, 1.2525, 1.2471, 1.2422, 1.2374, 1.2292, 1.2216, 1.2147, 1.2082, 1.2022, 1.1967, 1.1915, 1.1866,
    1.1820, 1.1777, 1.1737, 1.1699, 1.1663, 1.1613, 1.1540, 1.1472, 1.1406, 1.1344, 1.1285, 1.1228, 1.1175, 1.1123, 1.1074, 1.1027,
    1.0981, 1.0938, 1.0896, 1.0828, 1.0749, 1.0674, 1.0601, 1.0531, 1.0463, 1.0398, 1.0335, 1.0275, 1.0216, 1.0159, 1.0104, 1.0051,
  },

  { // 13: x1.426
    1.4258, 1.4258, 1.4258, 1.4258, 1.4258, 1.4258, 1.4258, 1.4258, 1.4258, 1.4250, 1.3979, 1.3757, 1.3573, 1.3416, 1.3282, 1.3166,
    1.3064, 1.2975, 1.2895, 1.2824, 1.2760, 1.2701, 1.2649, 1.2588, 1.2500, 1.2419, 1.2344, 1.2275, 1.2211, 1.2151, 1.2095, 1.2043,
    1.1994, 1.1948, 1.1905, 1.1864, 1.1825, 1.1765, 1.1686, 1.1612, 1.1541, 1.1473, 1.1409, 1.1348, 1.1289, 1.1233, 1.1180, 1.1128,
    1.1079, 1.1032, 1.0987, 1.0908, 1.0822, 1.0740, 1.0660, 1.0583, 1.0509, 1.0437, 1.0368, 1.0301, 1.0237, 1.0175, 1.0114, 1.0056,
  },

  { // 14: x1.469
    1.4685, 1.4685, 1.4685, 1.4685, 1.4685, 1.4685, 1.4685, 1.4685, 1.4685, 1.4590, 1.4300, 1.4063, 1.3865, 1.3698, 1.3555, 1.3431,
    1.3322, 1.3226, 1.3141, 1.3064, 1.2996, 1.2934, 1.2877, 1.2802, 1.2709, 1.2622, 1.2543, 1.2469, 1.2401, 1.2337, 1.2278, 1.2222,
    1.2170, 1.2121, 1.2075, 1.2031, 1.1990, 1.1919, 1.1834, 1.1753, 1.1677, 1.1604, 1.1534, 1.1468, 1.1405, 1.1345, 1.1287, 1.1232,
    1.1179, 1.1128, 1.1080, 1.0991, 1.0897, 1.0806, 1.0719, 1.0636, 1.0555, 1.0477, 1.0402, 1.0329, 1.0258, 1.0190, 1.0125, 1.0061,
  },

  { // 15: x1.513
    1.5126, 1.5126, 1.5126, 1.5126, 1.5126, 1.5126, 1.5126, 1.5126, 1.5126, 1.4929, 1.4621, 1.4369, 1.4158, 1.3980, 1.3828, 1.3696,
    1.3580, 1.3478, 1.3388, 1.3306, 1.3233, 1.3167, 1.3107, 1.3018, 1.2918, 1.2827, 1.2743, 1.2665, 1.2592, 1.2525, 1.2462, 1.2403,
    1.2348, 1.2296, 1.2247, 1.2201, 1.2158, 1.2074, 1.1983, 1.1896, 1.1814, 1.1736, 1.1662, 1.1591, 1.1523, 1.1459, 1.1397, 1.1338,
    1.1281, 1.1227, 1.1174, 1.1074, 1.0972, 1.0875, 1.0780, 1.0689, 1.0602, 1.0517, 1.0435, 1.0356, 1.0280, 1.0206, 1.0135, 1.0066,
  },

  { // 16: x1.558
    1.5580, 1.5580, 1.5580, 1.5580, 1.5580, 1.5580, 1.5580, 1.5580, 1.5580, 1.5267, 1.4941, 1.4674, 1.4452, 1.4263, 1.4102, 1.3962,
    1.3840, 1.3732, 1.3636, 1.3550, 1.3473, 1.3403, 1.3339, 1.3234, 1.3129, 1.3033, 1.2944, 1.2862, 1.2786, 1.2715, 1.2648, 1.2586,
    1.2528, 1.2473, 1.2422, 1.2374, 1.2328, 1.2231, 1.2134, 1.2042, 1.1954, 1.1871, 1.1792, 1.1716, 1.1644, 1.1575, 1.1509, 1.1445,
    1.1385, 1.1327, 1.1271, 1.1159, 1.1049, 1.0944, 1.0842, 1.0744, 1.0649, 1.0558, 1.0470, 1.0385, 1.0302, 1.0223, 1.0146, 1.0071,
  },

  { // 17: x1.605
    1.6047, 1.6047, 1.6047, 1.6047, 1.6047, 1.6047, 1.6047, 1.6047, 1.6035, 1.5605, 1.5261, 1.4980, 1.4745, 1.4547, 1.4377, 1.4229,
    1.4100, 1.3986, 1.3885, 1.3795, 1.3713, 1.3640, 1.3571, 1.3451, 1.3342, 1.3241, 1.3148, 1.3061, 1.2981, 1.2907, 1.2837, 1.2772,
    1.2711, 1.2654, 1.2600, 1.2549, 1.2499, 1.2390, 1.2287, 1.2189, 1.2096, 1.2007, 1.1923, 1.1843, 1.1766, 1.1693, 1.1622, 1.1555,
    1.1491, 1.1429, 1.1369, 1.1246, 1.1128, 1.1014, 1.0905, 1.0799, 1.0698, 1.0600, 1.0505, 1.0413, 1.0325, 1.0239, 1.0157, 1.0076,
  },

  { // 18: x1.653
    1.6528, 1.6528, 1.6528, 1.6528, 1.6528, 1.6528, 1.6528, 1.6528, 1.6393, 1.5942, 1.5581, 1.5285, 1.5039, 1.4831, 1.4652, 1.4497,
    1.4362, 1.4242, 1.4136, 1.4041, 1.3956, 1.3878, 1.3795, 1.3670, 1.3556, 1.3450, 1.3353, 1.3263, 1.3179, 1.3101, 1.3028, 1.2960,
    1.2896, 1.2836, 1.2780, 1.2727, 1.2667, 1.2552, 1.2442, 1.2338, 1.2240, 1.2146, 1.2057, 1.1972, 1.1890, 1.1813, 1.1738, 1.1667,
    1.1599, 1.1534, 1.1465, 1.1334, 1.1208, 1.1086, 1.0969, 1.0856, 1.0747, 1.0642, 1.0541, 1.0443, 1.0348, 1.0256, 1.0168, 1.0082,
  },

  { // 19: x1.702
    1.7024, 1.7024, 1.7024, 1.7024, 1.7024, 1.7024, 1.7024, 1.7024, 1.6751, 1.6279, 1.5901, 1.5591, 1.5334, 1.5116, 1.4929, 1.4767,
    1.4625, 1.4500, 1.4389, 1.4289, 1.4200, 1.4119, 1.4021, 1.3890, 1.3771, 1.3661, 1.3560, 1.3466, 1.3379, 1.3298, 1.3222, 1.3151,
    1.3084, 1.3022, 1.2963, 1.2908, 1.2837, 1.2715, 1.2600, 1.2490, 1.2386, 1.2287, 1.2193, 1.2103, 1.2017, 1.1935, 1.1857, 1.1782,
    1.1710, 1.1641, 1.1564, 1.1424, 1.1289, 1.1159, 1.1034, 1.0913, 1.0797, 1.0685, 1.0577, 1.0472, 1.0371, 1.0274, 1.0179, 1.0087,
  },

  { // 20: x1.754
    1.7535, 1.7535, 1.7535, 1.7535, 1.7535, 1.7535, 1.7535, 1.7535, 1.7108, 1.6615, 1.6221, 1.5898, 1.5629, 1.5402, 1.5206, 1.5037,
    1.4890, 1.4759, 1.4643, 1.4539, 1.4446, 1.4361, 1.4247, 1.4112, 1.3988, 1.3874, 1.3769, 1.3671, 1.3581, 1.3497, 1.3418, 1.3344,
    1.3275, 1.3211, 1.3150, 1.3092, 1.3009, 1.2881, 1.2759, 1.2644, 1.2535, 1.2430, 1.2331, 1.2237, 1.2146, 1.2060, 1.1977, 1.1898,
    1.1823, 1.1750, 1.1664, 1.1515, 1.1372, 1.1233, 1.1100, 1.0972, 1.0849, 1.0729, 1.0614, 1.0503, 1.0395, 1.0291, 1.0190, 1.0093,
  },

  { // 21: x1.806
    1.8061, 1.8061, 1.8061, 1.8061, 1.8061, 1.8061, 1.8061, 1.8061, 1.7465, 1.6952, 1.6541, 1.6205, 1.5925, 1.5689, 1.5485, 1.5310,
    1.5156, 1.5020, 1.4899, 1.4791, 1.4694, 1.4606, 1.4476, 1.4336, 1.4208, 1.4089, 1.3980, 1.3880, 1.3786, 1.3699, 1.3617, 1.3541,
    1.3470, 1.3402, 1.3339, 1.3280, 1.3184, 1.3049, 1.2922, 1.2801, 1.2686, 1.2576, 1.2472, 1.2373, 1.2278, 1.2187, 1.2101, 1.2018,
    1.1938, 1.1862, 1.1767, 1.1608, 1.1456, 1.1309, 1.1168, 1.1032, 1.0901, 1.0774, 1.0652, 1.0534, 1.0420, 1.0309, 1.0202, 1.0099,
  },

  { // 22: x1.860
    1.8603, 1.8603, 1.8603, 1.8603, 1.8603, 1.8603, 1.8603, 1.8506, 1.7821, 1.7288, 1.6862, 1.6513, 1.6223, 1.5977, 1.5766, 1.5583,
    1.5423, 1.5282, 1.5157, 1.5045, 1.4944, 1.4852, 1.4706, 1.4561, 1.4429, 1.4307, 1.4194, 1.4090, 1.3993, 1.3903, 1.3819, 1.3740,
    1.3667, 1.3597, 1.3532, 1.3471, 1.3361, 1.3220, 1.3087, 1.2960, 1.2839, 1.2725, 1.2616, 1.2512, 1.2412, 1.2317, 1.2227, 1.2140,
    1.2056, 1.1976, 1.1872, 1.1704, 1.1542, 1.1387, 1.1237, 1.1093, 1.0954, 1.0820, 1.0690, 1.0565, 1.0444, 1.0327, 1.0214, 1.0105,
  },

  { // 23: x1.916
    1.9161, 1.9161, 1.9161, 1.9161, 1.9161, 1.9161, 1.9161, 1.8886, 1.8171, 1.7614, 1.7169, 1.6805, 1.6502, 1.6245, 1.6025, 1.5834,
    1.5668, 1.5520, 1.5389, 1.5272, 1.5167, 1.5072, 1.4907, 1.4756, 1.4618, 1.4491, 1.4374, 1.4265, 1.4164, 1.4070, 1.3982, 1.3900,
    1.3823, 1.3751, 1.3683, 1.3619, 1.3496, 1.3349, 1.3210, 1.3079, 1.2953, 1.2834, 1.2721, 1.2613, 1.2509, 1.2411, 1.2316, 1.2226,
    1.2139, 1.2056, 1.1942, 1.1768, 1.1601, 1.1439, 1.1284, 1.1134, 1.0990, 1.0851, 1.0717, 1.0587, 1.0461, 1.0340, 1.0222, 1.0109,
  },

  { // 24: x1.974
    1.9736, 1.9736, 1.9736, 1.9736, 1.9736, 1.9736, 1.9736, 1.9257, 1.8504, 1.7919, 1.7451, 1.7068, 1.6749, 1.6479, 1.6247, 1.6046,
    1.5871, 1.5716, 1.5578, 1.5455, 1.5344, 1.5231, 1.5057, 1.4897, 1.4751, 1.4616, 1.4492, 1.4377, 1.4270, 1.4171, 1.4078, 1.3991,
    1.3910, 1.3834, 1.3762, 1.3694, 1.3557, 1.3406, 1.3264, 1.3128, 1.2999, 1.2877, 1.2760, 1.2649, 1.2543, 1.2441, 1.2344, 1.2251,
    1.2162, 1.2077, 1.1956, 1.1781, 1.1612, 1.1450, 1.1293, 1.1142, 1.0997, 1.0857, 1.0722, 1.0591, 1.0464, 1.0342, 1.0224, 1.0109,
  },

  { // 25: x2.033
    2.0328, 2.0328, 2.0328, 2.0328, 2.0328, 2.0328, 2.0328, 1.9621, 1.8832, 1.8219, 1.7728, 1.7326, 1.6992, 1.6708, 1.6466, 1.6255,
    1.6071, 1.5909, 1.5764, 1.5635, 1.5519, 1.5387, 1.5203, 1.5035, 1.4881, 1.4739, 1.4609, 1.4487, 1.4375, 1.4270, 1.4172, 1.4081,
    1.3995, 1.3915, 1.3839, 1.3767, 1.3617, 1.3463, 1.3316, 1.3177, 1.3044, 1.2919, 1.2799, 1.2685, 1.2576, 1.2471, 1.2372, 1.2276,
    1.2185, 1.2097, 1.1970, 1.1793, 1.1623, 1.1460, 1.1302, 1.1150, 1.1004, 1.0863, 1.0727, 1.0595, 1.0468, 1.0345, 1.0225, 1.0110,
  },

  { // 26: x2.094
    2.0938, 2.0938, 2.0938, 2.0938, 2.0938, 2.0938, 2.0938, 1.9979, 1.9155, 1.8514, 1.8001, 1.7581, 1.7231, 1.6935, 1.6681, 1.6462,
    1.6269, 1.6099, 1.5949, 1.5814, 1.5692, 1.5540, 1.5347, 1.5171, 1.5009, 1.4860, 1.4723, 1.4595, 1.4477, 1.4367, 1.4265, 1.4169,
    1.4079, 1.3994, 1.3915, 1.3840, 1.3677, 1.3518, 1.3367, 1.3224, 1.3089, 1.2960, 1.2837, 1.2719, 1.2608, 1.2501, 1.2398, 1.2301,
    1.2207, 1.2117, 1.1983, 1.1805, 1.1634, 1.1470, 1.1311, 1.1158, 1.1011, 1.0869, 1.0732, 1.0599, 1.0471, 1.0347, 1.0227, 1.0111,
  },

  { // 27: x2.157
    2.1566, 2.1566, 2.1566, 2.1566, 2.1566, 2.1566, 2.1477, 2.0331, 1.9472, 1.8803, 1.8269, 1.7831, 1.7467, 1.7159, 1.6894, 1.6665,
    1.6465, 1.6288, 1.6130, 1.5990, 1.5863, 1.5690, 1.5488, 1.5303, 1.5134, 1.4978, 1.4835, 1.4702, 1.4578, 1.4463, 1.4356, 1.4255,
    1.4161, 1.4072, 1.3989, 1.3907, 1.3734, 1.3572, 1.3417, 1.3271, 1.3132, 1.3000, 1.2874, 1.2754, 1.2639, 1.2529, 1.2425, 1.2324,
    1.2228, 1.2136, 1.1996, 1.1817, 1.1645, 1.1479, 1.1320, 1.1166, 1.1018, 1.0875, 1.0736, 1.0603, 1.0474, 1.0349, 1.0228, 1.0112,
  },

  { // 28: x2.221
    2.2213, 2.2213, 2.2213, 2.2213, 2.2213, 2.2213, 2.1867, 2.0676, 1.9783, 1.9089, 1.8533, 1.8078, 1.7699, 1.7379, 1.7104, 1.6866,
    1.6657, 1.6474, 1.6310, 1.6164, 1.6032, 1.5837, 1.5626, 1.5434, 1.5257, 1.5094, 1.4945, 1.4806, 1.4677, 1.4557, 1.4445, 1.4340,
    1.4242, 1.4149, 1.4062, 1.3967, 1.3791, 1.3625, 1.3467, 1.3317, 1.3174, 1.3039, 1.2910, 1.2787, 1.2670, 1.2558, 1.2450, 1.2348,
    1.2249, 1.2155, 1.2009, 1.1829, 1.1656, 1.1489, 1.1328, 1.1174, 1.1024, 1.0880, 1.0741, 1.0607, 1.0477, 1.0351, 1.0230, 1.0112,
  },

  { // 29: x2.288
    2.2879, 2.2879, 2.2879, 2.2879, 2.2879, 2.2879, 2.2251, 2.1016, 2.0089, 1.9369, 1.8793, 1.8321, 1.7928, 1.7596, 1.7311, 1.7064,
    1.6848, 1.6657, 1.6488, 1.6336, 1.6199, 1.5981, 1.5762, 1.5561, 1.5377, 1.5208, 1.5052, 1.4908, 1.4774, 1.4649, 1.4532, 1.4423,
    1.4321, 1.4225, 1.4134, 1.4027, 1.3847, 1.3677, 1.3515, 1.3362, 1.3216, 1.3078, 1.2946, 1.2820, 1.2700, 1.2585, 1.2476, 1.2371,
    1.2270, 1.2173, 1.2022, 1.1841, 1.1666, 1.1498, 1.1337, 1.1181, 1.1031, 1.0886, 1.0746, 1.0611, 1.0480, 1.0354, 1.0231, 1.0113,
  },

  { // 30: x2.357
    2.3566, 2.3566, 2.3566, 2.3566, 2.3566, 2.3566, 2.2627, 2.1349, 2.0390, 1.9645, 1.9049, 1.8561, 1.8154, 1.7810, 1.7515, 1.7259,
    1.7036, 1.6838, 1.6663, 1.6506, 1.6365, 1.6123, 1.5895, 1.5687, 1.5496, 1.5320, 1.5158, 1.5008, 1.4869, 1.4739, 1.4618, 1.4505,
    1.4399, 1.4299, 1.4205, 1.4086, 1.3902, 1.3728, 1.3562, 1.3406, 1.3257, 1.3116, 1.2981, 1.2852, 1.2730, 1.2612, 1.2500, 1.2393,
    1.2290, 1.2191, 1.2035, 1.1852, 1.1677, 1.1508, 1.1345, 1.1188, 1.1037, 1.0891, 1.0751, 1.0615, 1.0483, 1.0356, 1.0233, 1.0114,
  },

  { // 31: x2.427
    2.4273, 2.4273, 2.4273, 2.4273, 2.4273, 2.4273, 2.2997, 2.1677, 2.0686, 1.9916, 1.9300, 1.8796, 1.8376, 1.8021, 1.7716, 1.7452,
    1.7221, 1.7017, 1.6836, 1.6674, 1.6521, 1.6261, 1.6025, 1.5809, 1.5612, 1.5430, 1.5262, 1.5107, 1.4962, 1.4828, 1.4702, 1.4585,
    1.4475, 1.4372, 1.4274, 1.4144, 1.3955, 1.3778, 1.3609, 1.3449, 1.3297, 1.3153, 1.3015, 1.2884, 1.2759, 1.2639, 1.2524, 1.2415,
    1.2310, 1.2209, 1.2047, 1.1864, 1.1687, 1.1517, 1.1353, 1.1196, 1.1044, 1.0897, 1.0755, 1.0618, 1.0486, 1.0358, 1.0234, 1.0114,
  },

  { // 32: x2.500
    2.5001, 2.5001, 2.5001, 2.5001, 2.5001, 2.5001, 2.3360, 2.1998, 2.0977, 2.0183, 1.9548, 1.9028, 1.8595, 1.8229, 1.7914, 1.7642,
    1.7404, 1.7194, 1.7007, 1.6840, 1.6666, 1.6397, 1.6153, 1.5930, 1.5726, 1.5538, 1.5364, 1.5203, 1.5054, 1.4915, 1.4785, 1.4664,
    1.4550, 1.4443, 1.4343, 1.4200, 1.4008, 1.3827, 1.3655, 1.3492, 1.3337, 1.3189, 1.3049, 1.2915, 1.2787, 1.2665, 1.2548, 1.2436,
    1.2329, 1.2226, 1.2060, 1.1875, 1.1697, 1.1526, 1.1362, 1.1203, 1.1050, 1.0902, 1.0760, 1.0622, 1.0489, 1.0360, 1.0236, 1.0115,
  },

  { // 33: x2.575
    2.5751, 2.5751, 2.5751, 2.5751, 2.5751, 2.5679, 2.3716, 2.2315, 2.1264, 2.0446, 1.9792, 1.9257, 1.8811, 1.8433, 1.8110, 1.7830,
    1.7584, 1.7368, 1.7176, 1.7004, 1.6808, 1.6531, 1.6279, 1.6048, 1.5837, 1.5643, 1.5464, 1.5298, 1.5144, 1.5001, 1.4867, 1.4741,
    1.4624, 1.4514, 1.4410, 1.4256, 1.4060, 1.3875, 1.3700, 1.3533, 1.3375, 1.3225, 1.3082, 1.2945, 1.2815, 1.2691, 1.2571, 1.2457,
    1.2348, 1.2243, 1.2072, 1.1886, 1.1707, 1.1535, 1.1370, 1.1210, 1.1056, 1.0908, 1.0764, 1.0626, 1.0492, 1.0362, 1.0237, 1.0116,
  },

  { // 34: x2.652
    2.6523, 2.6523, 2.6523, 2.6523, 2.6523, 2.6084, 2.4066, 2.2626, 2.1545, 2.0704, 2.0032, 1.9482, 1.9023, 1.8635, 1.8303, 1.8015,
    1.7763, 1.7540, 1.7342, 1.7165, 1.6948, 1.6662, 1.6402, 1.6165, 1.5947, 1.5747, 1.5562, 1.5391, 1.5232, 1.5085, 1.4947, 1.4818,
    1.4696, 1.4583, 1.4476, 1.4310, 1.4111, 1.3922, 1.3744, 1.3574, 1.3413, 1.3260, 1.3114, 1.2975, 1.2842, 1.2716, 1.2594, 1.2478,
    1.2367, 1.2260, 1.2084, 1.1897, 1.1717, 1.1544, 1.1377, 1.1217, 1.1062, 1.0913, 1.0769, 1.0629, 1.0495, 1.0364, 1.0238, 1.0116,
  },

  { // 35: x2.732
    2.7319, 2.7319, 2.7319, 2.7319, 2.7319, 2.6481, 2.4410, 2.2931, 2.1822, 2.0959, 2.0268, 1.9703, 1.9233, 1.8834, 1.8493, 1.8197,
    1.7938, 1.7710, 1.7507, 1.7325, 1.7084, 1.6790, 1.6523, 1.6279, 1.6055, 1.5849, 1.5659, 1.5483, 1.5319, 1.5167, 1.5025, 1.4892,
    1.4768, 1.4651, 1.4541, 1.4364, 1.4161, 1.3969, 1.3787, 1.3614, 1.3450, 1.3294, 1.3146, 1.3004, 1.2869, 1.2740, 1.2617, 1.2498,
    1.2385, 1.2276, 1.2095, 1.1907, 1.1727, 1.1553, 1.1385, 1.1224, 1.1068, 1.0918, 1.0773, 1.0633, 1.0497, 1.0367, 1.0240, 1.0117,
  },

  { // 36: x2.814
    2.8139, 2.8139, 2.8139, 2.8139, 2.8139, 2.6872, 2.4748, 2.3231, 2.2093, 2.1209, 2.0501, 1.9922, 1.9439, 1.9030, 1.8680, 1.8377,
    1.8112, 1.7877, 1.7669, 1.7483, 1.7219, 1.6916, 1.6641, 1.6390, 1.6160, 1.5949, 1.5753, 1.5573, 1.5405, 1.5248, 1.5102, 1.4966,
    1.4838, 1.4718, 1.4604, 1.4416, 1.4210, 1.4014, 1.3829, 1.3654, 1.3487, 1.3328, 1.3177, 1.3033, 1.2896, 1.2764, 1.2638, 1.2518,
    1.2403, 1.2292, 1.2107, 1.1918, 1.1736, 1.1561, 1.1393, 1.1231, 1.1074, 1.0923, 1.0777, 1.0636, 1.0500, 1.0369, 1.0241, 1.0118,
  },

  { // 37: x2.898
    2.8983, 2.8983, 2.8983, 2.8983, 2.8983, 2.7255, 2.5080, 2.3526, 2.2361, 2.1455, 2.0729, 2.0136, 1.9642, 1.9224, 1.8865, 1.8554,
    1.8283, 1.8043, 1.7829, 1.7639, 1.7350, 1.7040, 1.6758, 1.6500, 1.6264, 1.6047, 1.5846, 1.5661, 1.5488, 1.5328, 1.5178, 1.5038,
    1.4907, 1.4783, 1.4667, 1.4468, 1.4258, 1.4059, 1.3871, 1.3692, 1.3523, 1.3361, 1.3208, 1.3061, 1.2921, 1.2788, 1.2660, 1.2538,
    1.2420, 1.2308, 1.2118, 1.1928, 1.1746, 1.1570, 1.1400, 1.1237, 1.1080, 1.0928, 1.0781, 1.0640, 1.0503, 1.0371, 1.0242, 1.0118,
  },

  { // 38: x2.985
    2.9852, 2.9852, 2.9852, 2.9852, 2.9852, 2.7631, 2.5405, 2.3816, 2.2624, 2.1696, 2.0955, 2.0348, 1.9842, 1.9414, 1.9047, 1.8729,
    1.8451, 1.8206, 1.7987, 1.7792, 1.7479, 1.7161, 1.6872, 1.6608, 1.6366, 1.6143, 1.5938, 1.5747, 1.5571, 1.5406, 1.5253, 1.5109,
    1.4974, 1.4848, 1.4729, 1.4518, 1.4305, 1.4103, 1.3912, 1.3730, 1.3558, 1.3394, 1.3238, 1.3089, 1.2947, 1.2811, 1.2681, 1.2557,
    1.2437, 1.2323, 1.2130, 1.1939, 1.1755, 1.1578, 1.1408, 1.1244, 1.1086, 1.0933, 1.0786, 1.0643, 1.0506, 1.0373, 1.0244, 1.0119,
  },

  { // 39: x3.075
    3.0748, 3.0748, 3.0748, 3.0748, 3.0748, 2.8000, 2.5725, 2.4100, 2.2882, 2.1934, 2.1176, 2.0556, 2.0039, 1.9601, 1.9227, 1.8902,
    1.8617, 1.8366, 1.8143, 1.7944, 1.7606, 1.7280, 1.6984, 1.6714, 1.6466, 1.6238, 1.6027, 1.5832, 1.5651, 1.5483, 1.5326, 1.5178,
    1.5041, 1.4911, 1.4789, 1.4568, 1.4351, 1.4146, 1.3952, 1.3768, 1.3592, 1.3426, 1.3267, 1.3116, 1.2972, 1.2834, 1.2702, 1.2575,
    1.2454, 1.2338, 1.2141, 1.1949, 1.1764, 1.1586, 1.1415, 1.1250, 1.1091, 1.0938, 1.0790, 1.0647, 1.0508, 1.0374, 1.0245, 1.0120,
  },

  { // 40: x3.167
    3.1670, 3.1670, 3.1670, 3.1670, 3.1670, 2.8362, 2.6039, 2.4380, 2.3136, 2.2168, 2.1394, 2.0761, 2.0233, 1.9786, 1.9403, 1.9071,
    1.8781, 1.8525, 1.8297, 1.8094, 1.7730, 1.7397, 1.7094, 1.6817, 1.6564, 1.6331, 1.6115, 1.5916, 1.5731, 1.5558, 1.5397, 1.5247,
    1.5106, 1.4973, 1.4848, 1.4617, 1.4397, 1.4189, 1.3991, 1.3804, 1.3626, 1.3457, 1.3296, 1.3142, 1.2996, 1.2856, 1.2722, 1.2593,
    1.2471, 1.2352, 1.2152, 1.1959, 1.1773, 1.1594, 1.1422, 1.1257, 1.1097, 1.0943, 1.0794, 1.0650, 1.0511, 1.0376, 1.0246, 1.0120,
  },

  { // 41: x3.262
    3.2620, 3.2620, 3.2620, 3.2620, 3.2271, 2.8717, 2.6348, 2.4655, 2.3386, 2.2398, 2.1608, 2.0962, 2.0424, 1.9968, 1.9577, 1.9239,
    1.8943, 1.8681, 1.8449, 1.8229, 1.7852, 1.7512, 1.7202, 1.6919, 1.6660, 1.6422, 1.6202, 1.5998, 1.5809, 1.5632, 1.5468, 1.5314,
    1.5170, 1.5034, 1.4901, 1.4665, 1.4441, 1.4230, 1.4030, 1.3840, 1.3660, 1.3488, 1.3324, 1.3169, 1.3020, 1.2878, 1.2742, 1.2611,
    1.2487, 1.2364, 1.2162, 1.1968, 1.1782, 1.1602, 1.1429, 1.1263, 1.1102, 1.0947, 1.0798, 1.0653, 1.0513, 1.0378, 1.0247, 1.0121,
  },

  { // 42: x3.360
    3.3599, 3.3599, 3.3599, 3.3599, 3.2689, 2.9066, 2.6650, 2.4925, 2.3631, 2.2624, 2.1819, 2.1160, 2.0611, 2.0147, 1.9749, 1.9404,
    1.9102, 1.8835, 1.8599, 1.8356, 1.7972, 1.7624, 1.7308, 1.7019, 1.6755, 1.6511, 1.6286, 1.6078, 1.5885, 1.5705, 1.5537, 1.5380,
    1.5233, 1.5095, 1.4952, 1.4712, 1.4485, 1.4271, 1.4068, 1.3875, 1.3692, 1.3518, 1.3352, 1.3194, 1.3043, 1.2899, 1.2761, 1.2629,
    1.2502, 1.2376, 1.2173, 1.1978, 1.1790, 1.1610, 1.1436, 1.1269, 1.1108, 1.0952, 1.0802, 1.0656, 1.0516, 1.0380, 1.0249, 1.0121,
  },

  { // 43: x3.461
    3.4607, 3.4607, 3.4607, 3.4607, 3.3099, 2.9408, 2.6948, 2.5190, 2.3872, 2.2847, 2.2027, 2.1356, 2.0796, 2.0323, 1.9918, 1.9566,
    1.9259, 1.8987, 1.8746, 1.8481, 1.8089, 1.7734, 1.7412, 1.7117, 1.6847, 1.6599, 1.6370, 1.6157, 1.5960, 1.5777, 1.5605, 1.5445,
    1.5295, 1.5154, 1.5001, 1.4758, 1.4528, 1.4311, 1.4105, 1.3910, 1.3724, 1.3548, 1.3379, 1.3219, 1.3066, 1.2920, 1.2780, 1.2646,
    1.2518, 1.2387, 1.2183, 1.1987, 1.1799, 1.1618, 1.1443, 1.1275, 1.1113, 1.0957, 1.0805, 1.0659, 1.0518, 1.0382, 1.0250, 1.0122,
  },

  { // 44: x3.565
    3.5645, 3.5645, 3.5645, 3.5645, 3.3500, 2.9744, 2.7239, 2.5450, 2.4109, 2.3065, 2.2230, 2.1547, 2.0978, 2.0497, 2.0084, 1.9726,
    1.9413, 1.9137, 1.8891, 1.8604, 1.8204, 1.7843, 1.7514, 1.7213, 1.6938, 1.6685, 1.6451, 1.6235, 1.6034, 1.5847, 1.5672, 1.5509,
    1.5355, 1.5212, 1.5050, 1.4803, 1.4571, 1.4350, 1.4142, 1.3944, 1.3756, 1.3577, 1.3406, 1.3244, 1.3089, 1.2941, 1.2799, 1.2663,
    1.2533, 1.2398, 1.2194, 1.1997, 1.1808, 1.1625, 1.1450, 1.1281, 1.1118, 1.0961, 1.0809, 1.0663, 1.0521, 1.0384, 1.0251, 1.0123,
  },

  { // 45: x3.671
    3.6715, 3.6715, 3.6715, 3.6715, 3.3894, 3.0073, 2.7526, 2.5706, 2.4342, 2.3280, 2.2431, 2.1736, 2.1157, 2.0667, 2.0247, 1.9884,
    1.9565, 1.9284, 1.9034, 1.8725, 1.8317, 1.7949, 1.7614, 1.7308, 1.7027, 1.6769, 1.6531, 1.6311, 1.6106, 1.5915, 1.5738, 1.5571,
    1.5415, 1.5268, 1.5098, 1.4848, 1.4612, 1.4389, 1.4177, 1.3977, 1.3786, 1.3605, 1.3432, 1.3268, 1.3111, 1.2961, 1.2817, 1.2680,
    1.2548, 1.2409, 1.2204, 1.2006, 1.1816, 1.1633, 1.1457, 1.1287, 1.1123, 1.0965, 1.0813, 1.0666, 1.0523, 1.0385, 1.0252, 1.0123,
  },

  { // 46: x3.782
    3.7816, 3.7816, 3.7816, 3.7816, 3.4281, 3.0396, 2.7807, 2.5957, 2.4570, 2.3491, 2.2628, 2.1922, 2.1333, 2.0835, 2.0409, 2.0039,
    1.9715, 1.9429, 1.9175, 1.8843, 1.8428, 1.8053, 1.7712, 1.7400, 1.7115, 1.6852, 1.6610, 1.6385, 1.6177, 1.5983, 1.5802, 1.5632,
    1.5474, 1.5324, 1.5144, 1.4892, 1.4653, 1.4427, 1.4213, 1.4009, 1.3817, 1.3633, 1.3458, 1.3292, 1.3132, 1.2980, 1.2835, 1.2696,
    1.2562, 1.2420, 1.2214, 1.2015, 1.1824, 1.1640, 1.1463, 1.1293, 1.1128, 1.0970, 1.0817, 1.0669, 1.0526, 1.0387, 1.0253, 1.0124,
  },

  { // 47: x3.895
    3.8950, 3.8950, 3.8950, 3.8950, 3.4659, 3.0713, 2.8083, 2.6204, 2.4795, 2.3699, 2.2822, 2.2104, 2.1507, 2.1001, 2.0567, 2.0191,
    1.9862, 1.9572, 1.9314, 1.8958, 1.8537, 1.8155, 1.7808, 1.7491, 1.7201, 1.6934, 1.6687, 1.6459, 1.6247, 1.6049, 1.5865, 1.5693,
    1.5531, 1.5379, 1.5190, 1.4934, 1.4693, 1.4464, 1.4247, 1.4042, 1.3846, 1.3660, 1.3483, 1.3315, 1.3154, 1.3000, 1.2853, 1.2712,
    1.2577, 1.2431, 1.2223, 1.2024, 1.1832, 1.1647, 1.1470, 1.1299, 1.1133, 1.0974, 1.0820, 1.0672, 1.0528, 1.0389, 1.0254, 1.0124,
  },
};

/*  Y Gamma Config Command */
#define PRINT_TABLE(table) ({ \
  int i; \
  ISP_DBG(ISP_MOD_GAMMA, "gamma table from chromatix"); \
  for(i=0; i<MAX_GAMMA_TABLE_SIZE/16; i++) \
    ISP_DBG(ISP_MOD_GAMMA, "%d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d", \
      table[i], table[i+1], table[i+2], table[i+3], table[i+4], \
      table[i+5], table[i+6], table[i+7], table[i+8], \
      table[i+9], table[i+10], table[i+11], table[i+12], \
      table[i+13], table[i+14], table[i+15]); })

/** gamma_update_tab_on_contrast:
 *    @contrast: contrast to be applied
 *    @ibits: table entry size in bits
 *    @input_table: input table
 *    @output_table: output table
 *
 *  This function updates gamma table depending on contrast
 *
 *  Return: TRUE  - Success
 *          FALSE - Input/Output table is NULL or contrast value is invalid
 **/
static int8_t gamma_update_tab_on_contrast(int contrast, int lut_size,
  isp_gamma_rgb_t *input_table_rgb, isp_gamma_rgb_t *output_table_rgb)
{
  int i;
  int entries;
  const uint8_t * gamma_table;
  entries = (lut_size >= 0) ? lut_size : 256;

  /* Apply Sigmoid Gamma Table */
  if (input_table_rgb == NULL || output_table_rgb == NULL) {
    ISP_DBG(ISP_MOD_GAMMA, "%s: input improper\n", __func__);

    return FALSE;
  }

  ISP_DBG(ISP_MOD_GAMMA, "%s: E, contrast = %d\n", __func__, contrast);
  switch (contrast) {
  case 10:
    gamma_table = ipl_gammaSigmoid2_4;
    break;

  case 9:
    gamma_table = ipl_gammaSigmoid2_1;
    break;

  case 8:
    gamma_table = ipl_gammaSigmoid1_8;
    break;

  case 7:
    gamma_table = ipl_gammaSigmoid1_5;
    break;

  case 6:
    gamma_table = ipl_gammaSigmoid1_2;
    break;
  case 5:
      /* the input and output table are the same */
        *output_table_rgb = *input_table_rgb;
      return TRUE;
  case 4:
    gamma_table = ipl_gammaSigmoid0_9;
    break;

  case 3:
    gamma_table = ipl_gammaSigmoid0_8;
    break;

  case 2:
    gamma_table = ipl_gammaSigmoid0_7;
    break;

  case 1:
    gamma_table = ipl_gammaSigmoid0_6;
    break;

  case 0:
    gamma_table = ipl_gammaSigmoid0_5;
    break;

  default:
    ISP_DBG(ISP_MOD_GAMMA, " %s: invalid contrast\n", __func__);
    return FALSE;
  }

  /* do look up */
  for (i = 0; i < entries; i++) {
    output_table_rgb->gamma_r[i] = gamma_table[input_table_rgb->gamma_r[i]];
    output_table_rgb->gamma_g[i] = gamma_table[input_table_rgb->gamma_g[i]];
    output_table_rgb->gamma_b[i] = gamma_table[input_table_rgb->gamma_b[i]];
  }

  ISP_DBG(ISP_MOD_GAMMA, "%s: success\n", __func__);

  return TRUE;
} /* gamma_update_tab_on_contrast */


/** get_hi_lo_gamma_bits
 *
 *  @table: gamma table
 *  @skipRatio: number of entries to be skipped
 *  @i: index in gamma table
 *
 *    The higher 8 bits in the configuration contains the delta between the
 *    current GammaTable value and the next value, while the lower 8 bits
 *    contains the current GammaTable value
 */
static int16_t get_hi_lo_gamma_bits(uint8_t *table, int skipRatio,
  int i)
{
  int16_t hw_lut_entry;
  uint8_t delta_lut;

  delta_lut = table[skipRatio*(i+1)] - table[skipRatio * i];
  hw_lut_entry = (int16_t)(delta_lut << GAMMA40_HW_PACK_BIT) + table[skipRatio * i];
  return hw_lut_entry;
}

/** get_last_gamma_value
 *
 *  @table: gamma table
 *  @skipRatio: number of entries to be skipped
 *
 */
static int16_t get_last_gamma_value(const uint8_t *table, const int skipRatio)
{
  int16_t hw_lut_entry;
  uint8_t delta_lut;

  /* consider the next entry of the last entry (255) to be 256.
     value 256 suggested by system team */
  uint32_t next_entry_final = 256;

  /* this is effectively  table[63] - table[62];
     this part is the delta */
  /* use 256 as next entry of last entry */
  delta_lut = next_entry_final -
    table[(ISP_GAMMA_NUM_ENTRIES - 1) * skipRatio];
  /* scale the delta */

  /* form the value:  upper byte is delta,
     lower byte is the entry itself. */
  hw_lut_entry = (int16_t)(delta_lut <<  GAMMA40_HW_PACK_BIT) +
    table[skipRatio * (ISP_GAMMA_NUM_ENTRIES - 1)];

  return hw_lut_entry;
}

/** gamma_update_vfe_table:
 *    @gamma_config_cmd: configuration command
 *    @table_rgb: pointer to table
 *    @size: size of the table
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function updates gamma table depending on contrast
 *
 *  Return: TRUE  - Success
 *          FALSE - Input/Output table is NULL or contrast value is invalid
 **/

static void gamma_update_vfe_table(volatile ISP_GammaConfigCmdType *
  gamma_config_cmd, isp_gamma_rgb_t *table_rgb, uint32_t lut_size)
{
  int i;
  uint8_t *table_r = table_rgb->gamma_r;
  uint8_t *table_g = table_rgb->gamma_g;
  uint8_t *table_b = table_rgb->gamma_b;

  /* ratio between number of LUT entries in Tuning data vs number of
     actual VFE gamma LUT entries.
     Decide how do we fill HW LUT from chromatix lut*/
  int skipRatio = lut_size / ISP_GAMMA_NUM_ENTRIES;

  for (i = 0; i < ISP_GAMMA_NUM_ENTRIES - 1; i++) {
    gamma_config_cmd->Gamatbl.hw_table_r[i] = get_hi_lo_gamma_bits(table_r, skipRatio, i);
    gamma_config_cmd->Gamatbl.hw_table_g[i] = get_hi_lo_gamma_bits(table_g, skipRatio, i);
    gamma_config_cmd->Gamatbl.hw_table_b[i] = get_hi_lo_gamma_bits(table_b, skipRatio, i);
  }

  gamma_config_cmd->Gamatbl.hw_table_r[ISP_GAMMA_NUM_ENTRIES - 1] =
    get_last_gamma_value(table_r, skipRatio);
  gamma_config_cmd->Gamatbl.hw_table_g[ISP_GAMMA_NUM_ENTRIES - 1] =
    get_last_gamma_value(table_g, skipRatio);
  gamma_config_cmd->Gamatbl.hw_table_b[ISP_GAMMA_NUM_ENTRIES - 1] =
    get_last_gamma_value(table_b, skipRatio);
} /* gamma_update_vfe_table */

/** set_gamma_table
 *
 *  @p_gamma_rgb: contain pointers to each color of gamma
 *  @gamma: single gamma table
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function initializes rgb gamma pointers
 *
 *  Return: None
 */
static void set_gamma_table(isp_gamma_rgb_t *gamma_rgb,
  uint8_t *gamma)
{
  memcpy(gamma_rgb->gamma_r, gamma, MAX_GAMMA_TABLE_SIZE * sizeof(uint8_t));
  memcpy(gamma_rgb->gamma_g, gamma, MAX_GAMMA_TABLE_SIZE * sizeof(uint8_t));
  memcpy(gamma_rgb->gamma_b, gamma, MAX_GAMMA_TABLE_SIZE * sizeof(uint8_t));
}


/** copy_gamma
 *
 *  @dst: destination
 *  @src: src
 *  @size: size
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function copies rgb gamma table
 *
 *  Return: None
 */
static void copy_gamma(isp_gamma_rgb_t *dst,
  isp_gamma_rgb_t *src, size_t size)
{
  memcpy(dst->gamma_r, src->gamma_r, size);
  memcpy(dst->gamma_g, src->gamma_g, size);
  memcpy(dst->gamma_b, src->gamma_b, size);
}

/**   chromatix_to_isp_gamma
 *
 *  @p_gamma_rgb: isp gamma rgb table
 *  @chromatix_gamma_table: chromoatix gamma table
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function initializes gamma table from chromatix
 *
 *  Return: None
 */
static void chromatix_to_isp_gamma(isp_gamma_rgb_t *gamma_rgb,
  chromatix_gamma_table_type *chromatix_gamma_table)
{
  memcpy(gamma_rgb->gamma_r, chromatix_gamma_table->gamma, GAMMA_TABLE_SIZE * sizeof(uint8_t));
  memcpy(gamma_rgb->gamma_g, chromatix_gamma_table->gamma, GAMMA_TABLE_SIZE * sizeof(uint8_t));
  memcpy(gamma_rgb->gamma_b, chromatix_gamma_table->gamma, GAMMA_TABLE_SIZE * sizeof(uint8_t));
}

/** gamma_interpolate
 *
 *    @tbl1: input table 1
 *    @tbl2: input table 2
 *    @out: out table
 *    @ratio:
 *
 *  Interpolate for each of tree colors RGB
 *  and summurise result in one table
 *
 *  Return: None
 */
static void gamma_interpolate(isp_gamma_rgb_t *tbl1,
    isp_gamma_rgb_t *tbl2, isp_gamma_rgb_t *gamma_rgb,
  float ratio)
{
  int i;

  TBL_INTERPOLATE_INT(tbl1->gamma_r, tbl2->gamma_r, gamma_rgb->gamma_r,
    ratio, MAX_GAMMA_TABLE_SIZE, i);
  TBL_INTERPOLATE_INT(tbl1->gamma_g, tbl2->gamma_g, gamma_rgb->gamma_g,
    ratio, MAX_GAMMA_TABLE_SIZE, i);
  TBL_INTERPOLATE_INT(tbl1->gamma_b, tbl2->gamma_b, gamma_rgb->gamma_b,
    ratio, MAX_GAMMA_TABLE_SIZE, i);
}

static float linear_interpolate(float x, uint32_t x_left, uint32_t x_right,
  float val_left, float val_right)
{
  float ratio = (x - (float)x_left) / (float)(x_right - x_left);
  return ratio * val_right + (1 - ratio) * val_left;
}

static void adrc_gamma_table_interpolate(uint8_t *gamma_in,
  uint8_t* gamma_out, adrc_gain_lut_t* cur_lut, int gamma_lut_size)
{
  int i = 0, x1 = 0, x2 = 0;
  float x_temp = 0.0f, val1 = 0.0f, val2 = 0.0f, cur_y = 0.0f;

  for(i = 0; i < gamma_lut_size; i++) {
    x_temp = i * ADRC_LUT_LENGTH / (float)gamma_lut_size;

    // Apply ADRC gain in linear domain
    x1 = (int)x_temp;
    x2 = x1 + 1;
    val1 = cur_lut->LUT[x1];
    if (x1 == ADRC_LUT_LENGTH - 1)
      val2 = 1.0f;
    else val2 = cur_lut->LUT[x2];
    x_temp = linear_interpolate(x_temp, x1, x2, val1, val2) * i;

    // Apply gamma
    x1 = (int)x_temp;
    if (x1 >= gamma_lut_size)
      x1 = gamma_lut_size - 1;
    x2 = x1 + 1;
    val1 = (float)gamma_in[x1];
    val2 = (float)(x2 == GAMMA_ENTRY_NUM ? (1 << GAMMA_BIT_WIDTH) : gamma_in[x2]);
    cur_y = linear_interpolate(x_temp, x1, x2, val1, val2);

    // Update gamma
    gamma_out[i] = (int)cur_y;
  }

  // First entry should always be 0
  gamma_out[0] = gamma_in[0];
}

static void adrc_gamma_update(isp_gamma_rgb_t *in,
  isp_gamma_rgb_t *out, adrc_gain_lut_t* cur_lut, int gamma_lut_size)
{
  int i = 0;
  adrc_gamma_table_interpolate(in->gamma_r, out->gamma_r, cur_lut, gamma_lut_size);
  adrc_gamma_table_interpolate(in->gamma_g, out->gamma_g, cur_lut, gamma_lut_size);
  adrc_gamma_table_interpolate(in->gamma_b, out->gamma_b, cur_lut, gamma_lut_size);
}


/** gamma_trigger_update:
 *    @mod: gamma module instance
 *    @trigger_params: module trigger update params
 *    @in_param_size: enable parameter size
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function checks and initiates triger update of module
 *
 *  Return:   0 - Success
 *           -1 - get aec ratio returned error
 **/
static int gamma_trigger_update(isp_gamma_mod_t *mod,
  isp_pix_trigger_update_input_t *trigger_params, uint32_t in_param_size)
{
  int rc = 0;
  int i;

  trigger_ratio_t trigger_ratio;
  trigger_point_type  *lowlight = NULL, *outdoor = NULL;
  isp_stats_udpate_t *stats_update =
    &trigger_params->trigger_input.stats_update;
  chromatix_parms_type *pchromatix =
    (chromatix_parms_type *)trigger_params->cfg.chromatix_ptrs.chromatixPtr;
  chromatix_gamma_type *pchromatix_gamma =
    &(pchromatix->chromatix_VFE.chromatix_gamma);
  chromatix_adrc_type *pchromatix_adrc =
    (chromatix_adrc_type *)trigger_params->cfg.chromatix_ptrs.chromatixAdrcPtr;
  tuning_control_type control_gamma;
  uint8_t is_burst = IS_BURST_STREAMING((&trigger_params->cfg));
  int backlight_comp_update = FALSE;
  int update_gamma = FALSE;
  isp_gamma_rgb_t contrast_gamma_table_rgb;

  if (!mod->enable) {
    ISP_DBG(ISP_MOD_GAMMA, "%s: gamma not enabled", __func__);

    return 0;
  }

  if (!mod->trigger_enable) {
    ISP_DBG(ISP_MOD_GAMMA, "%s: gamma trigger not enabled", __func__);

    return 0;
  }

  switch(trigger_params->cfg.effects.spl_effect) {
  case CAM_EFFECT_MODE_POSTERIZE:
  case CAM_EFFECT_MODE_SOLARIZE:
  case CAM_EFFECT_MODE_WHITEBOARD:
  case CAM_EFFECT_MODE_BLACKBOARD: {
    ISP_DBG(ISP_MOD_GAMMA, "%s: Special effect %d applied skip trigger",
      __func__, trigger_params->cfg.effects.spl_effect);
    gamma_update_vfe_table(&mod->ISP_GammaCfgCmd, &mod->gamma_table_rgb,
      mod->gamma_lut_size);
    return 0;
  }
    break;

  default:
    break;
  }

  if (!isp_util_aec_check_settled(&trigger_params->trigger_input.stats_update.aec_update)) {
    ISP_DBG(ISP_MOD_GAMMA, "%s: AEC not settled", __func__);
    /* return 0;  TODO remove this after 3a stable */
  }
  float drc_gain = trigger_params->trigger_input.stats_update.aec_update.drc_gain;
  float gamma_gain = trigger_params->trigger_input.stats_update.aec_update.gamma_gain;
  if(drc_gain > 1.0f && pchromatix_adrc) {
    control_gamma = pchromatix_adrc->adrc_gamma.control_gamma;
    lowlight =  &(pchromatix_adrc->adrc_gamma.gamma_lowlight_trigger);
    outdoor = &(pchromatix_adrc->adrc_gamma.gamma_outdoor_trigger);
  } else {
    control_gamma = pchromatix_gamma->control_gamma;
    lowlight =  &(pchromatix_gamma->gamma_lowlight_trigger);
    outdoor = &(pchromatix_gamma->gamma_outdoor_trigger);
  }

  rc = isp_util_get_aec_ratio2(mod->notify_ops->parent, control_gamma, outdoor,
     lowlight, &(stats_update->aec_update), is_burst, &trigger_ratio);

  backlight_comp_update = mod->enable_backlight_compensation &&
    stats_update->asd_update.backlight_detected &&
    (mod->backlight_severity !=
      stats_update->asd_update.backlight_scene_severity);

  ISP_DBG(ISP_MOD_GAMMA, "%s: bklight %d severity %d", __func__, backlight_comp_update,
     stats_update->asd_update.backlight_scene_severity);

  update_gamma =
    ((trigger_params->cfg.streaming_mode != mod->old_streaming_mode) ||
      !F_EQUAL(trigger_ratio.ratio, mod->gamma_ratio.ratio)) ||
    backlight_comp_update || mod->reload_params||
    (trigger_ratio.lighting != mod->gamma_ratio.lighting) ||
    !F_EQUAL(drc_gain, mod->drc_gain) ||
    !F_EQUAL(gamma_gain, mod->gamma_gain);

  ISP_DBG(ISP_MOD_GAMMA, "%s: update %d ratio %f lighting %d", __func__, update_gamma,
     trigger_ratio.ratio, trigger_ratio.lighting);

  if (update_gamma) {
    if (drc_gain > 1.0f){
      if (trigger_ratio.lighting == TRIGGER_OUTDOOR)
        gamma_interpolate(&mod->default_gamma_tbl_adrc, &mod->outdoor_gamma_tbl_adrc,
          &(mod->gamma_table_rgb), trigger_ratio.ratio);
      else if (trigger_ratio.lighting == TRIGGER_LOWLIGHT)
        gamma_interpolate(&mod->default_gamma_tbl_adrc, &mod->lowlight_gamma_tbl_adrc,
          &(mod->gamma_table_rgb), trigger_ratio.ratio);
      else
        copy_gamma(&(mod->gamma_table_rgb), &mod->default_gamma_tbl_adrc,
        MAX_GAMMA_TABLE_SIZE);

      if(isp_util_adrc_is_gain_valid(gamma_gain)) {
        isp_gamma_rgb_t gamma_updated;
        int tbl_idx = isp_util_adrc_get_lut_index(gamma_gain);
        adrc_gain_lut_t *cur_lut = &adrc_gain_lut_table[tbl_idx];

        ISP_DBG(ISP_MOD_GAMMA, "%s: gamma gain: %f, tbl_idx: %d", __func__, gamma_gain, tbl_idx);
        adrc_gamma_update(&mod->gamma_table_rgb, &gamma_updated, cur_lut, mod->gamma_lut_size);
        copy_gamma(&(mod->gamma_table_rgb), &gamma_updated,
          MAX_GAMMA_TABLE_SIZE);
      }
    }else {
      if (trigger_ratio.lighting == TRIGGER_OUTDOOR)
        gamma_interpolate(&mod->default_gamma_tbl, &mod->outdoor_gamma_tbl,
          &(mod->gamma_table_rgb), trigger_ratio.ratio);
      else if (trigger_ratio.lighting == TRIGGER_LOWLIGHT)
        gamma_interpolate(&mod->default_gamma_tbl, &mod->lowlight_gamma_tbl,
          &(mod->gamma_table_rgb), trigger_ratio.ratio);
      else
        copy_gamma(&(mod->gamma_table_rgb), &mod->default_gamma_tbl,
        MAX_GAMMA_TABLE_SIZE);
    }

    if (backlight_comp_update) {
      float bl_ratio =
        (float)stats_update->asd_update.backlight_scene_severity/255.0;
      ISP_DBG(ISP_MOD_GAMMA, "%s: bl_ratio %f", __func__, bl_ratio);

      bl_ratio = MIN(0, MAX(1.0, bl_ratio));
#if 0
      /* FIXME: there is no backlight gamma in chromatix 301 */
      TBL_INTERPOLATE_INT(pchromatix->backlight_gamma_table.gamma,
        mod->p_gamma_table, mod->p_gamma_table,
        bl_ratio, MAX_GAMMA_TABLE_SIZE, i);
#endif
      mod->backlight_severity =
        stats_update->asd_update.backlight_scene_severity;
    }
    mod->old_streaming_mode = trigger_params->cfg.streaming_mode;
    mod->gamma_ratio = trigger_ratio;
    mod->hw_update_pending = TRUE;
    mod->gamma_gain = gamma_gain;
    mod->drc_gain = drc_gain;
  }

  /* update based on contrast */
  if (trigger_params->cfg.bestshot_mode == CAM_SCENE_MODE_OFF) {
    switch(mod->gamma_table_type) {
      case GAMMA_TABLE_SOLARIZE:
      case GAMMA_TABLE_POSTERIZE:
      case GAMMA_TABLE_WHITE_BOARD:
      case GAMMA_TABLE_BLACK_BOARD:
      case GAMMA_TABLE_BACKLIGHT: {
        ISP_DBG(ISP_MOD_GAMMA, "%s: Dont apply contrast", __func__);
        gamma_update_vfe_table(&mod->ISP_GammaCfgCmd, &mod->gamma_table_rgb,
          mod->gamma_lut_size);
        break;
      }
      default: {
        ISP_DBG(ISP_MOD_GAMMA, "%s: Apply contrast %d trig_update %d", __func__, mod->contrast,
          mod->trigger_update);
        if (mod->contrast != DEFAULT_CONTRAST) {
          gamma_update_tab_on_contrast(mod->contrast,
            mod->gamma_lut_size, &(mod->gamma_table_rgb),
            &contrast_gamma_table_rgb);

          gamma_update_vfe_table(&mod->ISP_GammaCfgCmd, &contrast_gamma_table_rgb,
            mod->gamma_lut_size);
        } else {
          gamma_update_vfe_table(&mod->ISP_GammaCfgCmd, &mod->gamma_table_rgb,
            mod->gamma_lut_size);

        }
      }
    }
  } else {
    gamma_update_vfe_table(&mod->ISP_GammaCfgCmd, &mod->gamma_table_rgb,
      mod->gamma_lut_size);
  }

  ISP_DBG(ISP_MOD_GAMMA, "%s: Update gamma %d status %d, hw_update = %d",
    __func__, update_gamma, rc, mod->hw_update_pending);

  memcpy(&(trigger_params->cfg.gamma_rgb), &(mod->ISP_GammaCfgCmd.Gamatbl),
    sizeof(isp_gamma_t));

  return rc;
} /* isp_gamma_trigger_update */

/** gamma_set_table:
 *    @mod: gamma module instance
 *    @pix_settings: PIX parameters
 *    @gamma_table_type: gamma table type
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function sets gamma table depending on special effect/ bestshot.
 *
 *  Return:   0 - Success
 **/
static int gamma_set_table(isp_gamma_mod_t* mod,
  isp_hw_pix_setting_params_t *pix_settings, isp_gamma_table_t gamma_table_type)
{
   int rc =0;
   chromatix_parms_type *chromatix_ptr =
     (chromatix_parms_type *)pix_settings->chromatix_ptrs.chromatixPtr;
   chromatix_gamma_type *pchromatix_gamma =
     &(chromatix_ptr->chromatix_VFE.chromatix_gamma);

  ISP_DBG(ISP_MOD_GAMMA, "%s: gamma_table_type %d", __func__, gamma_table_type);

  mod->gamma_lut_size = GAMMA40_CHROMATIX_LUT_SIZE;
  switch (gamma_table_type) {
    case GAMMA_TABLE_OUTDOOR:
      chromatix_to_isp_gamma(&(mod->gamma_table_rgb),
        &(pchromatix_gamma->outdoor_gamma_table));
      mod->gamma_ratio.lighting = TRIGGER_OUTDOOR;
      mod->gamma_ratio.ratio = 0.0;
      break;

    case GAMMA_TABLE_LOWLIGHT:
      chromatix_to_isp_gamma(&(mod->gamma_table_rgb),
        &(pchromatix_gamma->lowlight_gamma_table));
      mod->gamma_ratio.lighting = TRIGGER_LOWLIGHT;
      mod->gamma_ratio.ratio = 0.0;
      break;

#if 0
    case GAMMA_TABLE_BACKLIGHT:
      chromatix_to_isp_gamma(&(mod->p_gamma_table_rgb),
        &(pchromatix_gamma->backlight_gamma_table));
      break;
#endif
    case GAMMA_TABLE_SOLARIZE:
      mod->gamma_table_rgb =  mod->solarize_gamma_table;
      break;

    case GAMMA_TABLE_POSTERIZE:
      set_gamma_table(&(mod->gamma_table_rgb),
        (uint8_t *)VFE_Posterization_GammaTable);
      mod->gamma_lut_size = 1024;
      break;

    case GAMMA_TABLE_WHITE_BOARD:
      set_gamma_table(&(mod->gamma_table_rgb),
        (uint8_t *)VFE_Whiteboard_GammaTable);
      mod->gamma_lut_size = 1024;
      break;

    case GAMMA_TABLE_BLACK_BOARD:
      set_gamma_table(&(mod->gamma_table_rgb),
        (uint8_t *)VFE_Blackboard_GammaTable);
      mod->gamma_lut_size = 1024;
      break;

    case GAMMA_TABLE_DEFAULT:
    default:
      chromatix_to_isp_gamma(&(mod->gamma_table_rgb),
        &(pchromatix_gamma->default_gamma_table));
      mod->gamma_ratio.lighting = TRIGGER_NORMAL;
      mod->gamma_ratio.ratio = 1.0;
      break;
  }
  mod->gamma_table_type = gamma_table_type;
  mod->hw_update_pending = TRUE;

  return rc;
} /* vfe_gamma_set_table */

/** gamma_set_bestshot:
 *    @mod: gamma module instance
 *    @pix_settings: PIX parameters
 *    @in_param_size: parameter size
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function configures gamma module according bestshot set.
 *
 *  Return:   0 - Success
 *           -1 - Parameter size mismatch
 **/
static int gamma_set_bestshot(isp_gamma_mod_t* mod,
  isp_hw_pix_setting_params_t *pix_settings, uint32_t in_param_size)
{
  int rc = 0;
  ISP_DBG(ISP_MOD_GAMMA, "%s: mode %d", __func__, pix_settings->bestshot_mode);

  if (in_param_size != sizeof(isp_hw_pix_setting_params_t)) {
    /* size mismatch */
    CDBG_ERROR("%s: size mismatch, expecting = %d, received = %d",
           __func__, sizeof(isp_hw_pix_setting_params_t), in_param_size);

    return -1;
  }

  switch(pix_settings->bestshot_mode) {
  case CAM_SCENE_MODE_LANDSCAPE:
  case CAM_SCENE_MODE_SNOW:
  case CAM_SCENE_MODE_BEACH:
  case CAM_SCENE_MODE_SPORTS:
  case CAM_SCENE_MODE_ACTION:
    rc = gamma_set_table(mod, pix_settings, GAMMA_TABLE_OUTDOOR);
    break;

  case CAM_SCENE_MODE_NIGHT:
  case CAM_SCENE_MODE_FIREWORKS:
  case CAM_SCENE_MODE_NIGHT_PORTRAIT:
    rc = gamma_set_table(mod, pix_settings, GAMMA_TABLE_LOWLIGHT);
    break;

  case CAM_SCENE_MODE_BACKLIGHT:
    rc = gamma_set_table(mod, pix_settings, GAMMA_TABLE_BACKLIGHT);
    break;

  default:
    rc = gamma_set_table(mod, pix_settings, GAMMA_TABLE_DEFAULT);
    break;
  }

  mod->trigger_enable = TRUE;

  if (rc == 0){
    ISP_DBG(ISP_MOD_GAMMA, "%s: enable update through BSM for mode : %d",__func__,
      pix_settings->bestshot_mode);
    mod->hw_update_pending = TRUE;
  }

  return rc;
} /* vfe_gamma_set_bestshot */

/** gamma_set_spl_effect:
 *    @mod: gamma module instance
 *    @pix_settings: PIX parameters
 *    @in_param_size: parameter size
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function configures gamma module according special effect set.
 *
 *  Return:   0 - Success
 *           -1 - Parameter size mismatch
 **/
static int gamma_set_spl_effect(isp_gamma_mod_t* mod,
  isp_hw_pix_setting_params_t *pix_settings, uint32_t in_param_size)
{
  int rc = 0;
  int type;
  chromatix_parms_type *chromatix =
    (chromatix_parms_type *)pix_settings->chromatix_ptrs.chromatixPtr;

  ISP_DBG(ISP_MOD_GAMMA, "%s: E\n",__func__);
  if (in_param_size != sizeof(isp_hw_pix_setting_params_t)) {
    /* size mismatch */
    CDBG_ERROR("%s: size mismatch, expecting = %d, received = %d",
           __func__, sizeof(isp_mod_set_enable_t), in_param_size);

    return -1;
  }

  if (pix_settings->bestshot_mode != CAM_SCENE_MODE_OFF) {
    CDBG_HIGH("%s: Best shot enabled, skip set effect", __func__);

    return 0;
  }

  type = pix_settings->effects.spl_effect;
  ISP_DBG(ISP_MOD_GAMMA, "%s: contrast %d effect type %d", __func__, mod->contrast, type);

  if(mod->contrast != DEFAULT_CONTRAST)
    switch(type) {
    case CAM_EFFECT_MODE_POSTERIZE:
    case CAM_EFFECT_MODE_BLACKBOARD:
    case CAM_EFFECT_MODE_WHITEBOARD:
    case CAM_EFFECT_MODE_SOLARIZE: {
      /* UI should prevent this */
      CDBG_HIGH("%s: Warning Overriding contrast value to default",
        __func__);
      mod->contrast = DEFAULT_CONTRAST;
      /* pix_settings->effects.contrast = DEFAULT_CONTRAST; */
    }
      break;

    default:
      break;
    }

  ISP_DBG(ISP_MOD_GAMMA, "%s: type %d", __func__, type);
  switch (type) {
  case CAM_EFFECT_MODE_POSTERIZE:
   rc = gamma_set_table(mod, pix_settings, GAMMA_TABLE_POSTERIZE);
    break;

  case CAM_EFFECT_MODE_SOLARIZE:
   rc = gamma_set_table(mod, pix_settings, GAMMA_TABLE_SOLARIZE);
    break;

  case CAM_EFFECT_MODE_BLACKBOARD:
   rc = gamma_set_table(mod, pix_settings, GAMMA_TABLE_BLACK_BOARD);
    break;

  case CAM_EFFECT_MODE_WHITEBOARD:
   rc = gamma_set_table(mod, pix_settings, GAMMA_TABLE_WHITE_BOARD);
    break;

  default:
   rc = gamma_set_table(mod, pix_settings, GAMMA_TABLE_DEFAULT);
    break;
  }

  if (rc == 0){
    ISP_DBG(ISP_MOD_GAMMA, "%s: enable update through special effect type %d",__func__, type);
    mod->hw_update_pending = TRUE;
  }

  return rc;
} /* gamma_set_spl_effect */

/** gamma_set_solarize_table:
 *    @mod: gamma module instance
 *    @chromatix_ptr: pointer to chromatix
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function sets solarize table
 *
 *  Return:   None
 **/
static void gamma_set_solarize_table(isp_gamma_mod_t *mod,
  chromatix_parms_type *chromatix_ptr)
{
  /* FIXME: There is no solorize reflection point in chromatix 301 */
  int i;
  uint16_t solarize_reflection_point = 0;
  chromatix_gamma_type *pchromatix_gamma =
    &(chromatix_ptr->chromatix_VFE.chromatix_gamma);
  isp_gamma_rgb_t Gamma_Lut;

  chromatix_to_isp_gamma(&Gamma_Lut, &(pchromatix_gamma->default_gamma_table));

  /* The solarize effect is achieved by inverting the output of the gamma table
     if the input is larger than reflex point. The output remains the same if                                                   .
     the input is less than or equal to the reflex point.
     The recommended reflex point is the midpoint of the input range e.g.
     128 for an 8-bit input */
  while( Gamma_Lut.gamma_r[solarize_reflection_point] <= GAMMA_REFLEX_POINT )
    solarize_reflection_point++;

  copy_gamma(&mod->solarize_gamma_table, &Gamma_Lut, solarize_reflection_point);

  for (i = solarize_reflection_point; i < GAMMA_TABLE_SIZE; i++) {
    mod->solarize_gamma_table.gamma_r[i]  =
      ((255 - Gamma_Lut.gamma_r[i]) * Gamma_Lut.gamma_r[solarize_reflection_point] /
       (255 - Gamma_Lut.gamma_r[solarize_reflection_point]));

    mod->solarize_gamma_table.gamma_g[i] =
      ((255 - Gamma_Lut.gamma_g[i]) * Gamma_Lut.gamma_g[solarize_reflection_point] /
       (255 - Gamma_Lut.gamma_g[solarize_reflection_point]));

    mod->solarize_gamma_table.gamma_b[i] =
      ((255 - Gamma_Lut.gamma_b[i]) * Gamma_Lut.gamma_b[solarize_reflection_point] /
       (255 - Gamma_Lut.gamma_b[solarize_reflection_point]));
  }
} /* vfe_gamma_get_table */

/** vfe_gamma_set_contrast:
 *    @mod: gamma module instance
 *    @pix_settings: PIX parameters
 *    @in_param_size: parameters size
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function sets gamma table depending on contrast
 *
 *  Return:   0: Success
 *           -1: Parameter size does not match
 **/
static int vfe_gamma_set_contrast(isp_gamma_mod_t *mod,
  isp_hw_pix_setting_params_t *pix_settings, uint32_t in_param_size)
{
  int rc = 0;

  if (in_param_size != sizeof(isp_hw_pix_setting_params_t)) {
    /* size mismatch */
    CDBG_ERROR("%s: size mismatch, expecting = %d, received = %d",
           __func__, sizeof(isp_hw_pix_setting_params_t), in_param_size);

    return -1;
  }

  ISP_DBG(ISP_MOD_GAMMA, "%s: bs_mode %d", __func__, pix_settings->bestshot_mode);
  if (pix_settings->bestshot_mode != CAM_SCENE_MODE_OFF) {
    CDBG_HIGH("%s: Warning Best shot enabled, ignore contast", __func__);

    return 0;
  }

  switch(mod->gamma_table_type) {
  case GAMMA_TABLE_SOLARIZE:
  case GAMMA_TABLE_POSTERIZE:
  case GAMMA_TABLE_BLACK_BOARD:
  case GAMMA_TABLE_WHITE_BOARD:
  case GAMMA_TABLE_BACKLIGHT: {
    CDBG_HIGH("%s: Warning Effect enabled, ignore contast", __func__);

    return 0;
  }
    break;

  default:
    break;
  }

  if (mod->contrast != pix_settings->effects.contrast) {
     ISP_DBG(ISP_MOD_GAMMA, "%s: contrast changed contrast = %d\n", __func__, mod->contrast);
     mod->contrast = pix_settings->effects.contrast;
     mod->hw_update_pending = TRUE;
  }

  ISP_DBG(ISP_MOD_GAMMA, "%s: X, hw_update = %d\n", __func__, mod->hw_update_pending);

  return rc;
} /* vfe_gamma_set_contrast */

/** gamma_set_effect
 *    @mod: gamma module instance
 *    @pix_settings: pix settings
 *    @in_param_size: pix settings size
 *
 *  Set gamma table according required effect.
 **/
static int gamma_set_effect(isp_gamma_mod_t* mod,
  isp_hw_pix_setting_params_t *pix_settings, uint32_t in_param_size)
{
  int rc = 0;
  uint32_t mask;
  chromatix_parms_type *chromatix =
    (chromatix_parms_type *)pix_settings->chromatix_ptrs.chromatixPtr;

  mask = pix_settings->effects.effect_type_mask;

  /* Special effect and contrast are mutually exclusive. Special effect has
     higher priority. Thus when special effect is applied, contrast is not
     applied and set to default */
  if (mask & (1 << ISP_EFFECT_SPECIAL)) {
    rc = gamma_set_spl_effect(mod, pix_settings, in_param_size);
    if(rc)
      goto END;
  }

  if (mask & (1 << ISP_EFFECT_CONTRAST)) {
    rc = vfe_gamma_set_contrast(mod, pix_settings, in_param_size);
    if(rc) {
      goto END;
    }
  }

END:
  return rc;
} /* gamma_set_effect */

/** gamma_reset:
 *    @mod: gamma module instance
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function resets gamma module to a known state
 *
 *  Return:   None
 **/
static void gamma_reset(isp_gamma_mod_t *mod)
{
  mod->old_streaming_mode = CAM_STREAMING_MODE_MAX;
  memset(&mod->ISP_GammaCfgCmd, 0, sizeof(mod->ISP_GammaCfgCmd));
  mod->hw_update_pending = 0;
  mod->trigger_update = 0;
  mod->trigger_enable = 0;
  mod->enable = 0;
  memset(&mod->gamma_table_rgb, 0, sizeof(mod->gamma_table_rgb));
  memset(&mod->solarize_gamma_table, 0, sizeof(mod->solarize_gamma_table));
  memset(&mod->gamma_ratio, 0, sizeof(mod->gamma_ratio));
  mod->gamma_lut_size = 0;
  mod->contrast = 0;
  mod->gamma_table_type = GAMMA_TABLE_DEFAULT;
  mod->backlight_severity = 0;
  mod->enable_backlight_compensation = 0;
  mod->reload_params = 0;
  mod->vfe_reconfig = 0;
}/* gamma_reset */

/** gamma_init:
 *    @mod_ctrl: gamma module instance
 *    @in_params: reset parmeters
 *    @notify_ops: module notification operations
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function initializes gamma module
 *
 *  Return:   None
 **/
static int gamma_init (void *mod_ctrl, void *in_params,
  isp_notify_ops_t *notify_ops)
{
  isp_gamma_mod_t *gamma = mod_ctrl;
  isp_hw_mod_init_params_t *init_params = in_params;

  gamma->fd = init_params->fd;
  gamma->notify_ops = notify_ops;
  gamma->old_streaming_mode = CAM_STREAMING_MODE_MAX;
  gamma_reset(gamma);

  return 0;
}/* gamma_init */

/** gamma_config:
 *    @gamma: gamma module instance
 *    @pix_settings: PIX parameters
 *    @in_param_size: PIX parameters size
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function makes initial configuration of gamma module
 *
 *  Return:   0 - Success
 *           -1 - Parameters size mismatch
 **/
static int gamma_config(isp_gamma_mod_t *gamma,
  isp_hw_pix_setting_params_t *pix_settings, uint32_t in_param_size)
{
  int  rc = 0;
  chromatix_parms_type *chromatix_ptr =
    (chromatix_parms_type *)pix_settings->chromatix_ptrs.chromatixPtr;
  chromatix_gamma_type *pchromatix_gamma =
      &(chromatix_ptr->chromatix_VFE.chromatix_gamma);
  chromatix_adrc_type *chromatix_adrc =
    (chromatix_adrc_type *)pix_settings->chromatix_ptrs.chromatixAdrcPtr;
  isp_gamma_rgb_t contrast_gamma_table_rgb;

  if (in_param_size != sizeof(isp_hw_pix_setting_params_t)) {
    /* size mismatch */
    CDBG_ERROR("%s: size mismatch, expecting = %d, received = %d",
         __func__, sizeof(isp_hw_pix_setting_params_t), in_param_size);

    return -1;
  }

  /*init gamma parameters*/
  gamma->contrast = pix_settings->effects.contrast;
  gamma->gamma_table_type = GAMMA_TABLE_DEFAULT;
  gamma->enable_backlight_compensation = TRUE;

  /*load chromatix to gamma*/
  chromatix_to_isp_gamma(&(gamma->gamma_table_rgb),
    &(pchromatix_gamma->default_gamma_table));
  gamma->gamma_lut_size = GAMMA40_CHROMATIX_LUT_SIZE;

  chromatix_to_isp_gamma(&gamma->default_gamma_tbl, &pchromatix_gamma->default_gamma_table);
  chromatix_to_isp_gamma(&gamma->lowlight_gamma_tbl, &pchromatix_gamma->lowlight_gamma_table);
  chromatix_to_isp_gamma(&gamma->outdoor_gamma_tbl, &pchromatix_gamma->outdoor_gamma_table);

  if(chromatix_adrc) {
    chromatix_to_isp_gamma(&gamma->default_gamma_tbl_adrc, &chromatix_adrc->adrc_gamma.default_gamma_table);
    chromatix_to_isp_gamma(&gamma->lowlight_gamma_tbl_adrc, &chromatix_adrc->adrc_gamma.lowlight_gamma_table);
    chromatix_to_isp_gamma(&gamma->outdoor_gamma_tbl_adrc, &chromatix_adrc->adrc_gamma.outdoor_gamma_table);
  }

  gamma_set_solarize_table(gamma, chromatix_ptr);

  if (pix_settings->bestshot_mode == CAM_SCENE_MODE_OFF) {
    /* compensate for contrast */
    switch(gamma->gamma_table_type) {
      case GAMMA_TABLE_SOLARIZE:
      case GAMMA_TABLE_POSTERIZE:
      case GAMMA_TABLE_BACKLIGHT:
      case GAMMA_TABLE_WHITE_BOARD:
      case GAMMA_TABLE_BLACK_BOARD:
        /* special effect, no contrast apply.
           config gamma HW table and configuration*/
        gamma_update_vfe_table(&gamma->ISP_GammaCfgCmd, &(gamma->gamma_table_rgb),
          gamma->gamma_lut_size);
        break;
      default:
        /* apply contrast, update the original table*/
        if (gamma->contrast != DEFAULT_CONTRAST) {
          gamma_update_tab_on_contrast(gamma->contrast,
            gamma->gamma_lut_size, &(gamma->gamma_table_rgb),
            &contrast_gamma_table_rgb);
          gamma_update_vfe_table(&gamma->ISP_GammaCfgCmd, &(contrast_gamma_table_rgb),
            gamma->gamma_lut_size);
        } else {
          /* contrast 5, defaul table, use original table*/
          gamma_update_vfe_table(&gamma->ISP_GammaCfgCmd, &(gamma->gamma_table_rgb),
            gamma->gamma_lut_size);
        }
        break;
    }
  } else {
    gamma_update_vfe_table(&gamma->ISP_GammaCfgCmd, &(gamma->gamma_table_rgb),
      gamma->gamma_lut_size);
  }

  /*config gamma HW table and configuration*/
  gamma->ISP_GammaCfgCmd.LutSel.ch0BankSelect = 0;
  gamma->ISP_GammaCfgCmd.LutSel.ch1BankSelect = 0;
  gamma->ISP_GammaCfgCmd.LutSel.ch2BankSelect = 0;

  gamma->hw_update_pending = TRUE;
  ISP_DBG(ISP_MOD_GAMMA, "%s: X\n", __func__);

  return rc;
} /* gamma_config */

/** gamma_enable:
 *    @gamma: gamma module instance
 *    @enable: true if module is to be enabled
 *    @in_param_size: enable parameter size
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function enables gamma module
 *
 *  Return:   0 - Success
 *           -1 - Parameters size mismatch
 **/
static int gamma_enable(isp_gamma_mod_t *gamma,
                isp_mod_set_enable_t *enable,
                uint32_t in_param_size)
{
  if (in_param_size != sizeof(isp_mod_set_enable_t)) {
    /* size mismatch */
    CDBG_ERROR("%s: size mismatch, expecting = %d, received = %d",
           __func__, sizeof(isp_mod_set_enable_t), in_param_size);

    return -1;
  }
  gamma->enable = enable->enable;

  return 0;
}

/** gamma_trigger_enable:
 *    @gamma: gamma module instance
 *    @enable: true if triger update is enabled
 *    @in_param_size: enable parameter size
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function enables triger update of gamma module
 *
 *  Return:   0 - Success
 *           -1 - Parameters size mismatch
 **/
static int gamma_trigger_enable(isp_gamma_mod_t *gamma,
                isp_mod_set_enable_t *enable,
                uint32_t in_param_size)
{
  if (in_param_size != sizeof(isp_mod_set_enable_t)) {
    /* size mismatch */
    CDBG_ERROR("%s: size mismatch, expecting = %d, received = %d",
           __func__, sizeof(isp_mod_set_enable_t), in_param_size);

    return -1;
  }

  gamma->trigger_enable = enable->enable;

  return 0;
} /* gamma_trigger_enable */

/** gamma_destroy:
 *    @mod_ctrl: gamma module instance
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function destroys gamma module
 *
 *  Return:   0 - Success
 **/
static int gamma_destroy (void *mod_ctrl)
{
  isp_gamma_mod_t *gamma = mod_ctrl;

  memset(gamma,  0,  sizeof(isp_gamma_mod_t));
  free(gamma);

  return 0;
} /* gamma_destroy */

/** gamma_set_params:
 *    @mod_ctrl: gamma module instance
 *    @param_id: parameter id
 *    @in_params: parameter data
 *    @in_param_size: parameter size
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function sets a parameter to gamma module
 *
 *  Return:   0 - Success
 *            Negative - paramter set error
 **/
static int gamma_set_params (void *mod_ctrl, uint32_t param_id,
                     void *in_params, uint32_t in_param_size)
{
  isp_gamma_mod_t *gamma = mod_ctrl;
  int rc = 0;
  ISP_DBG(ISP_MOD_GAMMA, "%s: param id = %d\n", __func__, param_id);

  switch (param_id) {
  case ISP_HW_MOD_SET_MOD_ENABLE:
    rc = gamma_enable(gamma, (isp_mod_set_enable_t *)in_params,
                     in_param_size);
    break;

  case ISP_HW_MOD_SET_MOD_CONFIG:
    rc = gamma_config(gamma, in_params, in_param_size);
    break;

  case ISP_HW_MOD_SET_TRIGGER_ENABLE:
    rc = gamma_trigger_enable(gamma, in_params, in_param_size);
    break;

  case ISP_HW_MOD_SET_TRIGGER_UPDATE:
    rc = gamma_trigger_update(gamma,
      (isp_pix_trigger_update_input_t *)in_params, in_param_size);
    break;

  case ISP_HW_MOD_SET_BESTSHOT:
     rc = gamma_set_bestshot(gamma, in_params, in_param_size);
     break;

  case ISP_HW_MOD_SET_EFFECT:
     rc = gamma_set_effect(gamma, in_params, in_param_size);
     break;

  default:
    CDBG_ERROR("%s: param_id is not supported in this module\n", __func__);
    break;
  }

  return rc;
} /* gamma_set_params */

/** gamma_get_params:
 *    @mod_ctrl: gamma module instance
 *    @param_id: parameter id
 *    @in_params: input parameter data
 *    @in_param_size: input parameter size
 *    @out_params: output parameter data
 *    @out_param_size: output parameter size
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function gets a parameter from gamma module
 *
 *  Return:   0 - Success
 *            Negative - paramter get error
 **/
static int gamma_get_params (void *mod_ctrl, uint32_t param_id,
                     void *in_params, uint32_t in_param_size,
                     void *out_params, uint32_t out_param_size)
{
  isp_gamma_mod_t *gamma = mod_ctrl;
  int rc =0;

  switch (param_id) {
  case ISP_HW_MOD_GET_MOD_ENABLE: {
    isp_mod_get_enable_t *enable = out_params;

    if (sizeof(isp_mod_get_enable_t) != out_param_size) {
      CDBG_ERROR("%s: error, out_param_size mismatch, param_id = %d",
                 __func__, param_id);
      break;
    }

    enable->enable = gamma->enable;
  }
    break;

  case ISP_HW_MOD_GET_TBLS: {
    mct_isp_table_t *isp_tbls = (mct_isp_table_t *)out_params;
    if (sizeof(mct_isp_table_t) != out_param_size) {
      CDBG_ERROR("%s: error, out_param_size mismatch, param_id = %d",
                 __func__, param_id);

      return -1;
    }

    if (gamma->enable && isp_tbls->gamma_table){
      memcpy(isp_tbls->gamma_table, &gamma->ISP_GammaCfgCmd.Gamatbl,
        sizeof(ISP_GammaTable));
      isp_tbls->gamma_num_entries = MAX_GAMMA_TABLE_SIZE;
    }
    break;
  }
  case ISP_HW_MOD_GET_TABLE_SIZE: {
    isp_hw_read_info *read_info = out_params;

    read_info->read_type = VFE_READ_DMI_16BIT;
    read_info->read_bank = RGBLUT_RAM_CH0_BANK0;
    read_info->bank_idx = 0;

    read_info->read_lengh =  sizeof(int16_t) * ISP_GAMMA_NUM_ENTRIES;
  }
    break;
  case ISP_HW_MOD_GET_DMI_DUMP_USER: {
    isp_hw_read_info *read_info = in_params;
    uint32_t *dmi_dump = (uint32_t *) out_params;

    memcpy(out_params, &gamma->applied_table, read_info->read_lengh);
  }
     break;

  case ISP_HW_MOD_GET_VFE_DIAG_INFO_USER: {
    vfe_diagnostics_t *vfe_diag = (vfe_diagnostics_t *)out_params;
    if (sizeof(vfe_diagnostics_t) != out_param_size) {
      CDBG_ERROR("%s: error, out_param_size mismatch, param_id = %d",
        __func__, param_id);
      break;
    }
    vfe_diag->control_gamma.enable = gamma->enable;
    vfe_diag->control_gamma.cntrlenable = gamma->trigger_enable;
    /*Populate vfe_diag data*/
    ISP_DBG(ISP_MOD_GAMMA, "%s: Populating vfe_diag data", __func__);
  }
    break;

  default:
    rc = -EPERM;
    break;
  }

  return rc;
}

/** gamma_get_params:
 *    @mod_ctrl: gamma module instance
 *    @gamma_channel: parameter id
 *
 *  This function runs in ISP HW thread context.
 *
 *  TODO
 *
 *  Return:   0 - Success
 **/
static int gamma_reset_dmi_cfg(isp_gamma_mod_t *gamma_mod,
  uint32_t gamma_channel)
{
  int i, rc = 0;
  struct msm_vfe_cfg_cmd2 cfg_cmd;
  struct msm_vfe_reg_cfg_cmd reg_cfg_cmd[2];
  uint32_t dmi_cfg[2];

  /* reset dmi cfg: config dmi channel and set auto increment*/
  dmi_cfg[0] = ISP40_DMI_CFG_DEFAULT;
  dmi_cfg[0] += gamma_channel;

  /* reset dmi_addr_cfg: dmi address always start form 0 */
  dmi_cfg[1] = 0;

  /* PACK the 2 cfg cmd for 1 ioctl*/
  cfg_cmd.cfg_data = &dmi_cfg;
  cfg_cmd.cmd_len = sizeof(dmi_cfg);
  cfg_cmd.cfg_cmd = (void *) &reg_cfg_cmd;
  cfg_cmd.num_cfg = 2;

  reg_cfg_cmd[0].u.rw_info.cmd_data_offset = 0;
  reg_cfg_cmd[0].cmd_type = VFE_WRITE_MB;
  reg_cfg_cmd[0].u.rw_info.reg_offset = ISP40_DMI_CFG_OFF;
  reg_cfg_cmd[0].u.rw_info.len = 1 * sizeof(uint32_t);

  reg_cfg_cmd[1].u.rw_info.cmd_data_offset =
    reg_cfg_cmd[0].u.rw_info.cmd_data_offset +
      reg_cfg_cmd[0].u.rw_info.len;
  reg_cfg_cmd[1].cmd_type = VFE_WRITE_MB;
  reg_cfg_cmd[1].u.rw_info.reg_offset = ISP40_DMI_ADDR;
  reg_cfg_cmd[1].u.rw_info.len = 1 * sizeof(uint32_t);

  rc = ioctl(gamma_mod->fd, VIDIOC_MSM_VFE_REG_CFG, &cfg_cmd);
  if (rc < 0){
    CDBG_ERROR("%s: gamma DMI update error, rc = %d", __func__, rc);

    return rc;
  }

  return rc;
} /* gamma_reset_dmi_cfg */

/** gamma_single_HW_write:
 *    @fd: device fd
 *    @cmd_offset:command
 *    @cmd_len: command length
 *    @hw_reg_offset: HW register offset
 *    @reg_num: number of registers
 *    @cmd_type: type of command
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function performs single HW write.
 *
 *  Return:   0 - Success
 **/
static int gamma_single_HW_write(uint32_t fd, void* cmd_offset,
  uint32_t cmd_len, uint32_t hw_reg_offset, uint32_t reg_num, uint32_t cmd_type)
{

  int rc = 0;
  struct msm_vfe_cfg_cmd2 cfg_cmd;
  struct msm_vfe_reg_cfg_cmd reg_cfg_cmd[1];

  cfg_cmd.cfg_data = cmd_offset;
  cfg_cmd.cmd_len = cmd_len;
  cfg_cmd.cfg_cmd = (void *) reg_cfg_cmd;
  cfg_cmd.num_cfg = 1;

  reg_cfg_cmd[0].u.rw_info.cmd_data_offset = 0;
  reg_cfg_cmd[0].cmd_type = cmd_type;
  reg_cfg_cmd[0].u.rw_info.reg_offset = hw_reg_offset;
  reg_cfg_cmd[0].u.rw_info.len = reg_num * sizeof(uint32_t);

  reg_cfg_cmd[0].u.dmi_info.hi_tbl_offset = 0;
  reg_cfg_cmd[0].u.dmi_info.lo_tbl_offset = 0;

  reg_cfg_cmd[0].u.dmi_info.hi_tbl_offset = 0;
  reg_cfg_cmd[0].u.dmi_info.lo_tbl_offset = 0;
  reg_cfg_cmd[0].u.dmi_info.len = cmd_len;

  rc = ioctl(fd, VIDIOC_MSM_VFE_REG_CFG, &cfg_cmd);
  if (rc < 0){
    CDBG_ERROR("%s: HW update error, rc = %d", __func__, rc);

    return rc;
  }

  return rc;

} /* gamma_single_HW_write */

/** gamma_dmi_hw_update:
 *    @gamma_mod:
 *    @bank_sel:
 *
 *  This function runs in ISP HW thread context.
 *
 *  TODO
 *
 *  Return:   0 - Success
 **/
static int gamma_dmi_hw_update(isp_gamma_mod_t *gamma_mod,
  ISP_GammaLutSelect bank_sel)
{
  int rc = 0;
  uint32_t dmi_cfg;
  uint32_t dmi_addr_reset = 0;

  int16_t *tbl_r = &gamma_mod->ISP_GammaCfgCmd.Gamatbl.hw_table_r[0];
  int16_t *tbl_g = &gamma_mod->ISP_GammaCfgCmd.Gamatbl.hw_table_g[0];
  int16_t *tbl_b = &gamma_mod->ISP_GammaCfgCmd.Gamatbl.hw_table_b[0];
  uint32_t tbl_len = sizeof(int16_t) * ISP_GAMMA_NUM_ENTRIES;

  uint32_t gamma_channel_0 =
    (bank_sel.ch0BankSelect == 0)? RGBLUT_RAM_CH0_BANK0 : RGBLUT_RAM_CH0_BANK1;
  uint32_t gamma_channel_1 =
    (bank_sel.ch1BankSelect == 0)? RGBLUT_RAM_CH1_BANK0 : RGBLUT_RAM_CH1_BANK1;
  uint32_t gamma_channel_2 =
    (bank_sel.ch2BankSelect == 0)? RGBLUT_RAM_CH2_BANK0 : RGBLUT_RAM_CH2_BANK1;

  /* 1. program DMI default value, write auto increment bit
     2. write DMI table
     3. reset DMI cfg
     4. flip the banksel bit*/

  /* write gamma channel 0 */
  gamma_reset_dmi_cfg(gamma_mod, gamma_channel_0);

  rc = gamma_single_HW_write(gamma_mod->fd, (void *)tbl_g, tbl_len,
    ISP40_DMI_DATA_LO, 1, VFE_WRITE_DMI_16BIT);

  if(rc < 0)
    gamma_reset_dmi_cfg(gamma_mod, ISP40_DMI_NO_MEM_SELECTED);

  /* write gamma channel 1 */
  gamma_reset_dmi_cfg(gamma_mod, gamma_channel_1);

  rc = gamma_single_HW_write(gamma_mod->fd, (void *)tbl_b, tbl_len,
    ISP40_DMI_DATA_LO, 1, VFE_WRITE_DMI_16BIT);

  if(rc < 0)
    gamma_reset_dmi_cfg(gamma_mod, ISP40_DMI_NO_MEM_SELECTED);

  /* write gamma channel 2 */
  gamma_reset_dmi_cfg(gamma_mod, gamma_channel_2);

  gamma_single_HW_write(gamma_mod->fd, (void *)tbl_r, tbl_len,
    ISP40_DMI_DATA_LO, 1, VFE_WRITE_DMI_16BIT);

  gamma_reset_dmi_cfg(gamma_mod, ISP40_DMI_NO_MEM_SELECTED);

  return rc;
} /* gamma_dmi_hw_update */

/** gamma_do_hw_update:
 *    @gamma_mod: gamma module instance
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function checks and sends configuration update to kernel
 *
 *  Return:   0 - Success
 *           -1 - configuration error
 **/
static int gamma_do_hw_update(isp_gamma_mod_t *gamma_mod)
{
  int i, rc = 0;
  ISP_DBG(ISP_MOD_GAMMA, "%s: hw_pending = %d\n", __func__, gamma_mod->hw_update_pending);
  if (gamma_mod->hw_update_pending) {

    gamma_dmi_hw_update(gamma_mod,
      gamma_mod->ISP_GammaCfgCmd.LutSel);

    isp_pipeline_util_single_HW_write(gamma_mod->fd,
    &gamma_mod->ISP_GammaCfgCmd, sizeof(gamma_mod->ISP_GammaCfgCmd.LutSel),
    ISP_RGB_LUT40_OFF, ISP_RGB_LUT40_LEN, VFE_WRITE);

    gamma_mod->ISP_GammaCfgCmd.LutSel.ch0BankSelect ^= 1;
    gamma_mod->ISP_GammaCfgCmd.LutSel.ch1BankSelect ^= 1;
    gamma_mod->ISP_GammaCfgCmd.LutSel.ch2BankSelect ^= 1;

    gamma_mod->applied_table = gamma_mod->ISP_GammaCfgCmd.Gamatbl;
    gamma_mod->hw_update_pending = 0;
  }

  return rc;
}/* gamma_do_hw_update */

/** gamma_action:
 *    @mod_ctrl: gamma module instance
 *    @action_code: action id
 *    @data: input parameter data
 *    @data_size: input parameter size
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function executes an gamma module action
 *
 *  Return:   0 - Success
 *            Negative - action execution error
 **/
static int gamma_action (void *mod_ctrl, uint32_t action_code, void *data,
  uint32_t data_size)
{
  int rc = 0;
  isp_gamma_mod_t *gamma = mod_ctrl;

  switch (action_code) {
  case ISP_HW_MOD_ACTION_HW_UPDATE:
    rc = gamma_do_hw_update(gamma);
    break;

  case ISP_HW_MOD_ACTION_RESET:
    gamma_reset(gamma);
    break;

  default:
    /* no op */
    rc = -EAGAIN;
    CDBG_HIGH("%s: action code = %d is not supported. nop",
              __func__, action_code);
    break;
  }

  return rc;
} /* gamma_action */

/** gamma40_open:
 *    @version: version
 *
 *  This function runs in ISP HW thread context.
 *
 *  This function instantiates a gamma module
 *
 *  Return:   NULL - not enough memory
 *            Otherwise handle to module instance
 **/
isp_ops_t *gamma40_open(uint32_t version)
{
  isp_gamma_mod_t *gamma = malloc(sizeof(isp_gamma_mod_t));

  if (!gamma) {
    /* no memory */
    CDBG_ERROR("%s: no mem",  __func__);

    return NULL;
  }
  memset(gamma,  0,  sizeof(isp_gamma_mod_t));
  gamma->ops.ctrl = (void *)gamma;
  gamma->ops.init = gamma_init;
  /* destroy the module object */
  gamma->ops.destroy = gamma_destroy;
  /* set parameter */
  gamma->ops.set_params = gamma_set_params;
  /* get parameter */
  gamma->ops.get_params = gamma_get_params;
  gamma->ops.action = gamma_action;

  return &gamma->ops;
} /* gamma40_open */
