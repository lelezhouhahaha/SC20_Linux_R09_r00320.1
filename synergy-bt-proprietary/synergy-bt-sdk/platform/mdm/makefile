.PHONY: all bt
ARCH := ARM

# QCA, BLUECORE
BT_CHIP_TYPE := QCA

USE_MDM_PLATFORM := 1

ifeq ($(BT_CHIP_TYPE), QCA)
CSR_USE_H4 := 1
else
CSR_USE_H4 := 0
endif

COMPILER_PREFIX := arm-linux-gnueabihf-
TOOLCHAIN_MAKEFILE := toolchain-linux-cross-compile.cmake
TARGET := pclin-generic-arm

OUTPUT_DIR := output/host

DEBUG_EANBLE := 1

SYNERGY_ROOT_DIR := $(shell pwd)

SYNERGY_SDK_DIR := $(SYNERGY_ROOT_DIR)/synergy-bt-sdk
SYNERGY_SDK_COMMON_DIR := $(SYNERGY_SDK_DIR)/common/synergy
SYNERGY_SDK_OUTPUT_DIR := $(SYNERGY_SDK_COMMON_DIR)/$(OUTPUT_DIR)
SYNERGY_SDK_LIB_DIR := $(SYNERGY_SDK_OUTPUT_DIR)/lib
SYNERGY_SDK_PLATFORM_DIR := $(SYNERGY_SDK_DIR)/platform/mdm/sdk
SYNERGY_SAMPLE_APP_DIR := $(SYNERGY_SDK_PLATFORM_DIR)/sample_app

SYNERGY_MIDDLEWARE_DIR := $(SYNERGY_ROOT_DIR)/synergy-middleware
SYNERGY_MIDDLEWARE_API_DIR := $(SYNERGY_MIDDLEWARE_DIR)/common/inc
SYNERGY_MIDDLEWARE_LIB_DIR := $(SYNERGY_MIDDLEWARE_DIR)/$(OUTPUT_DIR)/lib

CONFIG := default

MDM_ROOT_DIR := $(SYNERGY_ROOT_DIR)/../../../../..
MDM_PREBUILT_DIR := $(MDM_ROOT_DIR)/prebuilt/$(BASEMACHINE)
SYNERGY_PREBUILT_DIR := $(MDM_PREBUILT_DIR)/synergy
MDM_ROOT_DIR_FOR_HY11 := $(SYNERGY_ROOT_DIR)/../../../../../../../..
MDM_PREBUILT_DIR_FOR_HY11 := $(MDM_ROOT_DIR_FOR_HY11)/prebuilt_HY11/$(BASEMACHINE)
SYNERGY_PREBUILT_DIR_FOR_HY11 := $(MDM_PREBUILT_DIR_FOR_HY11)/synergy

all: bt

export ARCH TARGET SYNERGY_SDK_DIR DEBUG_EANBLE CONFIG CSR_USE_H4IBS BT_CHIP_TYPE USE_MDM_PLATFORM

CMAKE_BT_DEFINITION += -DCMAKE_VERBOSE_MAKEFILE:STRING=1 \
			-DSYNERGY_NOSHIP:BOOL=$(SYNERGY_NOSHIP) \
			-DCSR_BT_ROOT:PATH=$(SYNERGY_SDK_COMMON_DIR)/bt \
			-DCSR_BT_CONFIG:STRING=lite \
			-DCMAKE_TOOLCHAIN_FILE:FILEPATH=$(SYNERGY_SDK_COMMON_DIR)/fw/build/$(TOOLCHAIN_MAKEFILE) \
			-DCSR_LOG_ENABLE:BOOL=$(DEBUG_EANBLE) \
			-DEXCLUDE_CSR_BT_VCARD_MODULE:BOOL=OFF \
			-DBT_CHIP_TYPE:STRING=$(BT_CHIP_TYPE) \
			-DCSR_USE_H4IBS:BOOL=$(CSR_USE_H4IBS) \
			-DUSE_MDM_PLATFORM:BOOL=$(USE_MDM_PLATFORM) \
			-DUSE_MDM_CHIP:STRING=$(BASEMACHINE) \
			-DARCH:STRING=$(ARCH) \
			-DMDM_ROOT=$(MDM_ROOT_DIR)

bt:
# copy synergy api & lib
#	mkdir $(SYNERGY_SDK_COMMON_DIR) -p
	mkdir $(SYNERGY_SDK_OUTPUT_DIR) -p
	(test -d $(SYNERGY_PREBUILT_DIR) && cp -rf $(SYNERGY_PREBUILT_DIR)/* $(SYNERGY_SDK_OUTPUT_DIR)) || echo "Sourcecode Build"
	(test -d $(SYNERGY_PREBUILT_DIR_FOR_HY11) && cp -rf $(SYNERGY_PREBUILT_DIR_FOR_HY11)/* $(SYNERGY_SDK_OUTPUT_DIR)) || echo "HY11 Build"

# copy connx api & lib
	mkdir $(SYNERGY_SDK_LIB_DIR) -p
	cp -rf $(SYNERGY_MIDDLEWARE_API_DIR)/* $(SYNERGY_SDK_COMMON_DIR)/bt/applications/inc
	cp -rf $(SYNERGY_MIDDLEWARE_LIB_DIR)/* $(SYNERGY_SDK_LIB_DIR)

# copy synergy sample app
#	cp -rf $(SYNERGY_SAMPLE_APP_DIR)/bt $(SYNERGY_SDK_COMMON_DIR)

	cd $(SYNERGY_SDK_OUTPUT_DIR)&&cmake -G 'Unix Makefiles' $(SYNERGY_SDK_COMMON_DIR)/fw $(CMAKE_BT_DEFINITION)
	make -C $(SYNERGY_SDK_OUTPUT_DIR) all	
